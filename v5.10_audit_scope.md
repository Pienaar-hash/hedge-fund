Here’s a Codex audit prompt you can drop into a file like
`codex_audit_risk_usdc_v5.10.md` and feed to the CLI.

---

# Codex Audit Scope — USDC Fees, Strategy Config, Risk Gating, Asset Universe

You are auditing the **hedge-fund** repo for execution and risk config hardening around:

1. **Migrating to USDC-quoted perps** (0.00% maker fees) instead of USDT where feasible
2. **Strategy configuration sanity** (we haven’t touched it in a few sprints)
3. **Risk gating / risk_limits vs ~4k USDC NAV**
4. **Asset-universe & bucket system** (is it still necessary / used correctly?)

Treat this as a **config + infra audit**, not a full rewrite.

---

## Environment & Constraints

* Exchange: **Binance UM Futures**, `dualSide: true`, hedge mode enabled.
* Execution pipeline: v5.10-style with:

  * Canonical `send_order` boundary and `_ORDER_PARAM_WHITELIST`
  * Firestore **disabled/no-op** (local-only telemetry and doctor).
  * NAV = **trading NAV only** (no reserves / treasury).
* Capital: plan is to keep **≈4 000 USDC** in the account. Assume **USDC perps have 0% maker fees** and USDT perps have non-zero maker fees.
* Safety:

  * Do **not** weaken or bypass any existing kill-switches, NAV floors, daily loss limits, or exposure caps.
  * Do **not** enable new symbols or strategies by default without making that explicit in the diff and comments.
  * Keep all `ENV` / `ALLOW_PROD_WRITE` protections intact.

Work in **three phases**: (1) map current behaviour, (2) propose changes, (3) emit patch.

---

## 1. Fee-aware asset universe & quote preference (USDC focus)

**Goal:** Bias the system toward **USDC-quoted perps** (e.g. `BTCUSDC`, `ETHUSDC`, etc.) where liquid, to benefit from 0% maker fees — *without* breaking any existing strategy that currently expects USDT.

Tasks:

1. **Locate where tradable symbols are defined and grouped**, for example:

   * `config/` files like `symbols.json`, `asset_universe.json`, `asset_buckets.json`, `strategy_config.json`.
   * Any Python helpers that generate the asset universe (e.g. under `execution/` or `utils/`).

2. For each strategy:

   * Identify **which symbols** it currently trades (BTC, ETH, etc.) and **which quote** (`USDT`, `USDC`, other).
   * Determine if the strategy code assumes a specific quote (e.g. hard-coded `BTCUSDT`).

3. Propose a **minimal, fee-aware universe** for ~4k USDC NAV:

   * Prefer a **small, high-liquidity set** of USDC pairs (e.g. `BTCUSDC`, `ETHUSDC`) plus any must-have USDT pairs that are deeply wired into logic.
   * Keep the total number of active symbols modest to avoid dilution of risk and complexity.

4. Implementation request:

   * Introduce or adjust a **config layer** (e.g. `config/asset_universe.json` or similar) that:

     * Clearly marks **preferred USDC symbols**.
     * Marks any legacy USDT-only symbols as such (e.g. `"quote": "USDT"`).
   * Ensure any **symbol selection helpers** read from this config and can prioritize USDC quotes where both USDT and USDC exist.

Output in your patch:

* A short comment block near the asset-universe config explaining:

  > USDC-quoted perps preferred due to 0% maker fees; USDT perps retained only where necessary.

---

## 2. Strategy config review (fresh sanity pass)

**Goal:** Review and lightly harden **`config/strategy_config.*`** so it is coherent with:

* USDC base capital (~4k)
* Binance minimum notional rules
* Current live risk posture

Tasks:

1. Find the **main strategy config** (likely `config/strategy_config.json` or similar).

   * Enumerate all configured strategies and their key params:

     * Symbols
     * `max_trade_nav_pct`, `min_gross_nav_pct`, `capital_per_trade_usdt`, etc.
     * Any per-symbol overrides.

2. Check for **obvious drift / cruft**:

   * Unused strategies, disabled blocks, or TODOs that no longer apply.
   * Parameters that make no sense for a ~4k USDC NAV (e.g. capital_per_trade_usdt that would over-allocate or trigger notional errors).

3. With ~4k USDC NAV in mind:

   * Sanity-check that per-trade sizing makes sense versus:

     * Binance min notional (~100 USD unless using reduceOnly).
     * Our risk limits (see Section 3).
   * Recommend **target ranges** for:

     * `max_trade_nav_pct` (per strategy).
     * `capital_per_trade_usdt` (absolute floors/ceilings per symbol).

4. Implementation request:

   * Tighten any clearly misaligned values (e.g. unrealistic `capital_per_trade_usdt`) and annotate with short comments indicating they’re tuned for ~4k NAV.
   * Leave more speculative tweaks as **commented suggestions**, not active changes, unless they are obviously broken.

---

## 3. Risk gating & risk_limits vs 4k USDC

**Goal:** Ensure **risk gating & caps** are internally consistent and appropriate for a ~4k USDC live book, and that the logic still does what we think it does.

Focus files/modules (names approximate; infer exact paths from repo):

* `config/risk_limits.json`
* `execution/risk_limits.py` (or similar risk gating module)
* Any NAV floor constants, daily loss limits, per-symbol exposure caps.

Tasks:

1. **Map the current risk model:**

   * Global caps: `max_gross_exposure_pct`, `per_symbol max_nav_pct`, etc.
   * Per-symbol caps, including BTC/ETH.
   * `NAV_FLOOR` and any “stop trading below this NAV” logic.
   * Daily loss limits and cool-down logic (e.g. Autotune outputs).

2. Evaluate them against **4k USDC**:

   * Compute approximate max notional per symbol and global max.
   * Check that typical BTC/ETH position sizes would:

     * Clear Binance min-notional (100 USD).
     * Not over-leverage the account.

3. Implementation request:

   * If any caps are **clearly too loose or too tight**, propose adjusted values in `risk_limits.json` and add a short comment:

     * Example: `"max_symbol_exposure_pct": 35` with `// tuned for ~4k USDC live; ensures single-symbol notional <= ~1.4k`.
   * Ensure **no logic is left referencing old reserves/treasury-based equity**; risk gating should be **NAV-only**.

4. Confirm that:

   * **Doctor** and any risk diagnostics still read the correct fields after the earlier NAV refactors.
   * There are no dead flags (e.g. `USE_FUTURES`-style toggles) interfering with the actual gating.

---

## 4. Asset buckets: necessary or legacy?

**Goal:** Decide whether the current **bucket system** (if still present) is required, and either simplify or retire it cleanly.

Tasks:

1. Search for **“bucket”** in the repo:

   * `config/*` (e.g. `asset_buckets.json`, `buckets.json`).
   * Any code in `execution/` or `utils/` referencing buckets.

2. Build a **usage map**:

   * Which strategies or modules actively read bucket definitions?
   * What do they use them for (e.g. weighting, rotation, filters, risk scaling)?

3. Decide:

   * If **used in a meaningful way**:

     * Keep buckets, but simplify:

       * Minimize to a small, clear set (e.g. “majors”, “alts”, “experimental”).
       * Ensure USDC priority is reflected (see Section 1).
       * Add comments tying bucket sizing to risk limits and ~4k NAV.

   * If mostly **legacy / unused**:

     * Mark config as deprecated (comment header).
     * Remove or gate any code paths that try to use it, so there’s no silent half-use.
     * Don’t break tests; if tests depend on buckets, either:

       * Update them to reflect the new, minimal definition, or
       * Update them to assert that buckets are not required for core trading.

---

## 5. Deliverables

Please proceed in this order:

1. **Audit Notes (no code yet)**

   * Brief markdown-ish notes (in your response) summarizing:

     * Current strategy config (per strategy).
     * Current risk limits (global and per-symbol).
     * Current asset universe & buckets + how they’re used.

2. **Patch Plan**

   * A clear, bullet-point patch plan grouped by:

     * Asset universe / USDC migration
     * Strategy config tweaks
     * Risk limits tuning
     * Bucket system cleanup

3. **Code & Config Changes**

   * Emit **unified diffs** for:

     * `config/strategy_config.*`
     * `config/risk_limits.*`
     * Any asset-universe / bucket config files you touch
     * Any Python modules you must adjust for the above

4. **Tests / Checks to run**
   At the end, list the exact commands we should run, e.g.:

   ```bash
   python -m pytest tests/test_exchange_dry_run.py tests/test_risk_limits.py -q
   python -m scripts.doctor -v | tail -n 60
   ```

Keep changes **surgical, well-commented, and backwards-safe**. Avoid expanding scope beyond the four areas above.
