# v7.6 Runtime Activation Runbook

Operational guide for deploying and activating GPT-Hedge v7.6 in production.

---

## 1. Preconditions

Before beginning activation:

- [ ] `VERSION` file contains `v7.6`
- [ ] CI is green on `main` or `v7.6-dev` branch
- [ ] Access to runtime box via SSH
- [ ] Access to `logs/state/` directory
- [ ] Dashboard URL accessible
- [ ] Supervisor access for service restart

---

## 2. Preflight Commands

Run these commands from the repository root:

```bash
# Activate virtual environment
source venv/bin/activate

# Run preflight Make target
make pretag-v7.6

# Run runtime sanity check
python scripts/runtime_sanity_check_v7_6.py
```

### What Success Looks Like

**`make pretag-v7.6` output:**
```
VERSION check: v7.6 ✓
Running test-fast...
All tests passed ✓
Running targeted integration tests...
test_manifest_state_contract.py ✓
test_state_surface_health.py ✓
test_state_publish_diagnostics.py ✓
test_state_publish_factor_diagnostics.py ✓
test_risk_snapshot_contract.py ✓
test_state_positions_ledger_contract.py ✓
Preflight complete ✓
```

**`runtime_sanity_check_v7_6.py` output:**
```
=== v7.6 Runtime Sanity Check ===

NAV State:
  nav_total: 12345.67 USDT
  nav_age_s: 15.2
  freshness: OK

DD State:
  dd_state: NORMAL
  dd_pct: -2.3%
  risk_mode: NORMAL

Router Quality:
  global_quality_score: 0.85
  symbols_tracked: 12
  avg_slippage_bps: 1.2
  avg_latency_ms: 45

Exit Coverage:
  coverage_pct: 94.5%
  open_positions: 8
  tp_sl_registered: 8
  underwater_without_tp_sl: 0

Factor Weights:
  trend: 0.22
  carry: 0.18
  rv_momentum: 0.15
  router_quality: 0.12
  expectancy: 0.20
  vol_regime: 0.13

All checks passed ✓
```

---

## 3. Deploying v7.6

### 3.1 Pull Updated Code

**Option A: Git checkout**
```bash
cd /root/hedge-fund
git fetch --tags origin
git checkout v7.6
```

**Option B: Docker image**
```bash
docker pull <registry>/gpt-hedge:v7.6
docker-compose up -d
```

### 3.2 Restart Supervisor Services

```bash
# Restart all hedge services
sudo supervisorctl restart hedge:

# Or restart individually
sudo supervisorctl restart hedge:hedge-executor
sudo supervisorctl restart hedge:hedge-dashboard
sudo supervisorctl restart hedge:sync-state
```

### 3.3 Verify Logs

Check executor boot logs show engine version v7.6:
```bash
tail -50 /var/log/hedge-executor.out.log | grep -i version
# Expected: "Engine version: v7.6" or similar
```

Check for startup errors:
```bash
tail -100 /var/log/hedge-executor.err.log
# Should be clean or show only warnings
```

Check state_publish is writing successfully:
```bash
tail -20 /var/log/hedge-executor.out.log | grep state_publish
# Should see regular writes with no repeated errors
```

---

## 4. Post-Activation Checks

### 4.1 State Files Verification

Check all canonical state files exist and are fresh:

```bash
cd /root/hedge-fund/logs/state

# List files with timestamps
ls -la *.json

# Check individual file freshness (should be within last 2 minutes)
cat nav.json | jq '.updated_ts'
cat nav_state.json | jq '.updated_ts'
cat positions_state.json | jq '.updated_at'
cat positions_ledger.json | jq '.updated_at'
cat kpis_v7.json | jq '.updated_at'
cat diagnostics.json | jq '.runtime_diagnostics.exit_pipeline.last_exit_scan_ts'
cat risk_snapshot.json | jq '.updated_ts'
cat router_health.json | jq '.updated_ts'
cat engine_metadata.json | jq '{version, started_ts}'
```

**Expected files:**
- `nav.json`, `nav_state.json` — NAV surfaces
- `positions_state.json`, `positions_ledger.json` — Position surfaces
- `kpis_v7.json` — KPIs
- `diagnostics.json` — Runtime diagnostics
- `risk_snapshot.json` — Risk KPIs
- `router_health.json` — Router microstructure
- `symbol_scores_v6.json` — Intel scores (per intel run)
- `factor_diagnostics.json` — Factor analytics (per intel run)
- `engine_metadata.json` — Engine version metadata

### 4.2 Dashboard Verification

Open dashboard URL and verify:

- [ ] **Regime strip visible** at top of dashboard
  - Vol Regime badge (LOW/NORMAL/ELEVATED/HIGH)
  - DD State badge (NORMAL/DRAWDOWN/RECOVERY)
  - Router Quality badge (score + status)
  - Risk Mode badge

- [ ] **NAV/Risk panel renders**
  - Current NAV displayed
  - Drawdown percentage shown
  - Risk mode indicator

- [ ] **Router health metrics populated**
  - Global quality score
  - Per-symbol breakdown available
  - Slippage/latency stats visible

- [ ] **Exit coverage visible**
  - Coverage percentage > 90% (or configured threshold)
  - Mismatch breakdown if discrepancies exist
  - No unexpected underwater-without-TP/SL

- [ ] **Factor diagnostics panel renders**
  - Factor weights displayed
  - IR values visible
  - Orthogonalization status shown

- [ ] **System Health panel**
  - Engine version shows `v7.6`
  - No missing/stale surface warnings

---

## 5. Rollback Plan

If issues are discovered post-activation:

### 5.1 Quick Rollback Steps

```bash
# 1. Checkout previous stable tag
cd /root/hedge-fund
git fetch --tags origin
git checkout v7.5  # or previous stable tag

# 2. Restart services
sudo supervisorctl restart hedge:

# 3. Verify rollback
tail -50 /var/log/hedge-executor.out.log | grep -i version
# Should show previous version

# 4. Run sanity check for previous version
python scripts/runtime_sanity_check_v7_6.py  # may show partial failures, that's OK
```

### 5.2 State Surface Compatibility

State surfaces are forward-compatible. On rollback:

- v7.5 will read v7.6 state files successfully (ignores new fields)
- Some v7.6-only fields (e.g., `mismatch_breakdown`, `anomalies`) will be missing
- Dashboard may show "missing field" warnings for v7.6-specific data
- No data loss or corruption expected

### 5.3 Rollback Verification

After rollback, verify:
```bash
# Check logs for errors
tail -100 /var/log/hedge-executor.err.log

# Verify state files are being written
ls -la logs/state/*.json

# Dashboard should render (possibly with missing v7.6 features)
curl -s http://localhost:8501/healthz
```

---

## 6. Incident Hooks

### NAV Anomaly Triggers

If `risk_snapshot.json` shows `anomalies.nav_jump = true`:

1. Check NAV state for jump magnitude:
   ```bash
   cat logs/state/risk_snapshot.json | jq '.anomalies'
   ```
2. Review recent trades for large PnL events
3. If false positive, adjust `max_nav_jump_pct` in `config/risk_limits.json`
4. See [v7.6 Incident Playbooks](v7.6_Incident_Playbooks.md#nav-anomalies)

### Router Idle or Degraded

If router_health shows quality < 0.5 or idle status:

1. Check router health state:
   ```bash
   cat logs/state/router_health.json | jq '.router_health.global'
   ```
2. Review per-symbol metrics for degraded symbols
3. Check exchange connectivity and API rate limits
4. See [v7.6 Incident Playbooks](v7.6_Incident_Playbooks.md#router-degradation)

### Exit Coverage Drops

If exit coverage falls below threshold:

1. Check diagnostics:
   ```bash
   cat logs/state/diagnostics.json | jq '.runtime_diagnostics.exit_pipeline'
   ```
2. Review `mismatch_breakdown` for specific issues
3. Check TP/SL registry for missing entries
4. See [v7.6 Incident Playbooks](v7.6_Incident_Playbooks.md#exit-coverage)

### DD State Transitions

If DD state transitions unexpectedly:

1. Check risk snapshot:
   ```bash
   cat logs/state/risk_snapshot.json | jq '{dd_state, drawdown, anomalies}'
   ```
2. Review portfolio drawdown history
3. If `dd_flap` is true, investigate rapid transitions
4. See [v7.6 Incident Playbooks](v7.6_Incident_Playbooks.md#drawdown-governance)

---

## 7. Ops Log Template

After activation, document in your ops log:

```
=== v7.6 Activation Log ===
Date/Time: YYYY-MM-DD HH:MM UTC
Operator: <name>
Commit Hash: <git rev-parse HEAD>
VERSION: v7.6

Preflight Results:
- make pretag-v7.6: PASS/FAIL
- runtime_sanity_check: PASS/FAIL

Deployment Steps:
- Code pulled: [timestamp]
- Services restarted: [timestamp]
- Dashboard verified: [timestamp]

Post-Activation State:
- NAV: <value>
- DD State: <state>
- Router Quality: <score>
- Exit Coverage: <percentage>
- Factor Weights: <summary>

Anomalies Observed:
- <list any issues or "None">

Notes:
- <additional observations>
```

---

## Related Documentation

- [v7.6 Release Notes](v7.6_Release_Notes.md)
- [v7.6 Change Log](v7.6_Change_Log.md)
- [v7.6 Pre-Tag Audit](v7.6_Pre_Tag_Audit.md)
- [v7.6 Incident Playbooks](v7.6_Incident_Playbooks.md)
- [v7.6 State Contract](v7.6_State_Contract.md)
