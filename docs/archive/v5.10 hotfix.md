# ‚úÖ **High-Level Review ‚Äî What the Probe Output Means**

Your latest probe output:

```
{"symbol": "BTCUSDT", "would_emit": false,
 "reasons": ["trade_gt_10pct_equity"], ... }
```

and then with explicit notional:

```
{"symbol": "BTCUSDT", "would_emit": false,
 "reasons": ["trade_gt_10pct_equity", "trade_gt_max_trade_nav_pct"], ... }
```

tells us **exactly one thing**:

üëâ **The 10% equity clamp is still enabled and firing FIRST ‚Äî before the new 15%/20% v5.10 limits.**

That is the only reason the screener refuses all trades.

Your diff earlier suggested this clamp had been raised, but the runtime behavior shows:

### ‚úîÔ∏è **The 10% threshold is still in active code**

‚Ä¶and is evaluated **before** max_trade_nav_pct or trade_equity_nav_pct.

Meaning:

* even a $300 test order on a $4400 NAV (‚âà6.8%) **should pass**,
* but the screener marks it as **trade_gt_10pct_equity**
  ‚Üí this means the guard is **still hard-coded** or **still loaded from config**.

---

# üîç **Root Cause**

The probe and screener both import:

### `execution.signal_screener.would_emit()`

Inside that function, the following are still present in runtime:

* an **equity clamp** reading from:

  * the config if present, or
  * old default values still defined inside the module.

Even though the patch said it was normalised, the probe output **proves** we‚Äôre still executing the legacy threshold.

Additional evidence:

* `compute_trade_nav_pct()` is no longer importable
  ‚Üí the refactor removed or renamed functions, but the screener still references the old path.
* max_trade_nav_pct and trade_equity_nav_pct normalisation hasn‚Äôt completed end-to-end.
* probe script `would_emit()` still returns `["trade_gt_10pct_equity"]` ‚Äî that string only exists in the **old v5.8 ‚Üí v5.9 path.**

This confirms:

### ‚ùó We have a **partial upgrade** where

**risk_limits ‚Üí OK**
**risk_limits.check_order ‚Üí OK**
**sizer ‚Üí OK**
**executor ‚Üí OK**
**BUT SCREENER STILL USES OLD 10% HARD-CODED LOGIC**

This is why:

* probe fails,
* screener fails,
* intents are not emitted,
* executor never routes anything.

---

# üîß **What Must Be Repaired (final v5.10 hotfix)**

To finish v5.10:

---

## **1. Remove/Replace legacy 10% clamp in `signal_screener.py`**

Search for any of these:

```
trade_gt_10pct_equity
0.10
equity_pct > 0.10
```

Replace with the new config-driven values:

* `trade_equity_nav_pct = 0.15`
* `max_trade_nav_pct = 0.20`

and ensure they are pulled from:

```
risk_cfg["global"]["trade_equity_nav_pct"]
risk_cfg["global"]["max_trade_nav_pct"]
```

---

## **2. Make screener use unified risk_limits.check_order()**

Currently screener gates first, independently.

It must instead:

‚úîÔ∏è compute rough suggested notional
‚úîÔ∏è call check_order(symbol, notional, side, lev, nav, ‚Ä¶)
‚úîÔ∏è use that return (bool, detail)

This guarantees:

* same logic as executor
* same thresholds
* no divergence

---

## **3. Ensure screener normalises caps before gating**

Inside screener:

* ensure `%` values from config are multiplied by NAV
* ensure notional caps check match sizer
* ensure concurrency gating uses new config-driven limits

---

## **4. Add missing helper functions imports / remove dead code**

Your probe logs show:

```
ImportError: cannot import name 'compute_trade_nav_pct'
```

This means leftover references exist.

Clean up any screener functions referencing:

* compute_trade_nav_pct
* compute_trade_nav_obs
* trade_nav_pct_legacy
* equity_clamp_legacy

---

## **5. Validate with:**

```
python -m pytest tests/test_screener_tier_caps.py
python -m scripts.screener_probe BTCUSDT ETHUSDT SOLUSDT --nav 4400 --notional 300
```

Expected output after patch:

```
{"symbol": "BTCUSDT", "would_emit": true, "reasons": []}
```

---

# üöÄ **What I will do next (once you say ‚ÄúProceed‚Äù)**

I will generate a **Codex-ready patch prompt** that:

* isolates ONLY the screener
* reconciles config-driven clamps
* routes everything through check_order
* cleans dead imports
* fixes concurrency application
* ensures detail payloads match the unified risk API

This will be a **surgical patch**, not touching executor/risk/sizer.
