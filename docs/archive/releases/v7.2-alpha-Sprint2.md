# v7.2-alpha — Sprint 2 Release Notes
## Adaptive Strategies, Router Autotune, PnL Attribution & Diagnostics

Release type: **internal alpha**  
Scope: **Strategy Adaptation, Router Autotune, PnL Attribution, Diagnostics, Adaptive Weighting**  
Status: **All new tests passing; no known regressions**  

---

## 1. Overview

Sprint 2 lifts v7 from a “correct, risk-safe engine” to an **adaptive, regime-aware trading stack**:

- Strategies now **shrink, gate, and annotate** themselves based on ATR, drawdown, and risk mode.
- The router stack **autotunes maker offsets** and maker-first decisions from real router health telemetry.
- A new **PnL Attribution Engine** exposes symbol/strategy/regime/risk-mode/day breakdowns.
- The dashboard now includes **Attribution** and **Portfolio Diagnostics** panels.
- A **Strategy Weighting Engine** applies **adaptive portfolio weights** per strategy on top of the unlevered sizing contract.

Core invariants (NAV risk contract, unlevered sizing, veto logic, JSONL logging) remain intact.

---

## 2. Changes by Area

### 2.1 Strategy Layer — Adaptive Sizing (PATCHSET F)

**Files:**  
- `execution/strategy_adaptation.py`  
- `execution/signal_screener.py`  
- `execution/state_publish.py`  
- `execution/position_sizing.py`  
- `config/strategy_config.json`  
- `tests/test_strategy_adaptation.py`

**What changed:**

- Introduced a dedicated **strategy_adaptation** module encapsulating:
  - ATR regime shrink maps  
  - Drawdown regime shrink maps  
  - Risk-mode shrink maps  
  - Per-strategy overrides + resilient telemetry loaders
- Screener now:
  - Loads regimes & risk mode from real state files (`regimes.json`, `risk_snapshot.json`)
  - Calls `strategy_enablement` to block intents in **HALTED** or critical DD regimes
  - Applies `adaptive_sizing` *before* qty computation
  - Stamps `intent.metadata.adaptive` with regime + factor info
- State publishing preserves the metadata block so downstream consumers can see how each intent was adapted.

**Impact:**  
Strategies are now **regime-aware** without touching risk veto logic or NAV invariants.

---

### 2.2 Router Layer — Autotune (PATCHSET G)

**Files:**  
- `execution/intel/router_autotune_shared.py`  
- `execution/router_metrics.py`  
- `execution/executor_live.py`  
- `execution/intel/maker_offset.py`  
- `execution/order_router.py`  
- `tests/test_router_autotune.py`

**What changed:**

- New `router_autotune_shared` helper:
  - Computes **per-symbol maker reliability** from router health stats
  - Suggests adaptive offsets and maker-first flags, conditioned on **risk_mode**
- Router metrics now:
  - Compute and emit `maker_reliability` per symbol
  - Attach `adaptive_offset_bps` and `maker_first` into `router_health` snapshots
- Executor wiring:
  - Rebuilds router health snapshots from real event counts
  - Ensures `logs/state/router_health.json` carries **adaptive metadata** with no schema breaks
- Router call path:
  - `maker_offset` and `order_router` both consume the shared autotune helper
  - Final routing decisions now respect reliability + risk mode (DEFENSIVE/HALTED).

**Impact:**  
The router **learns from its own slippage and rejects**, and respects global risk mode when deciding how aggressively to chase maker fills.

---

### 2.3 PnL Attribution Engine (PATCHSETS H1 + H2)

**Files:**  
- `execution/pnl_tracker.py`  
- `execution/state_publish.py`  
- `logs/state/pnl_attribution.json` (NEW)  
- `tests/test_pnl_attribution_core.py`  
- `tests/test_pnl_attribution_h2.py`

**What changed:**

- **H1 – Core Attribution:**
  - Reads `trades.jsonl` + `positions.json`
  - Aggregates **per-symbol** and **per-strategy**:
    - realized PnL
    - unrealized PnL
    - total PnL
    - trade count
  - Writes `logs/state/pnl_attribution.json` alongside `equity.json`
  - Handles missing telemetry gracefully (zeros and safe defaults).

- **H2 – Regime / Risk / Per-Day:**
  - Extends the same snapshot with:
    - `per_regime.atr` and `per_regime.dd`
    - `per_risk_mode` buckets
    - `per_day` PnL keyed by UTC date
  - Uses the real regime and risk-mode surfaces (`regimes.json`, `risk_snapshot.json`)
  - Preserves backward compatibility with H1 schema.

**Impact:**  
We now have a **single canonical attribution surface** suitable for diagnostics, strategy evaluation, and later ML/analytical tooling.

---

### 2.4 Dashboard — Attribution Panel (PATCHSET H3)

**Files:**  
- `dashboard/utils/attribution_loaders.py`  
- `dashboard/pnl_attribution_panel.py` (NEW)  
- `dashboard/overview_panel.py`  
- `tests/test_dashboard_attribution_panel.py`

**What changed:**

- Safe loader for `pnl_attribution.json` with defensive accessors.
- New Attribution panel renders:
  - Summary stats (total PnL, realized/unrealized, win rate, trade count, ts)
  - Per-symbol and per-strategy tables + bar charts
  - Regime and risk-mode attribution blocks
  - Daily PnL strip chart
- Integrated into the overview as a dedicated Attribution section/tab.
- All UI functions handle partial/missing data without crashing.

**Impact:**  
PnL attribution is now **visible to operators and investors** with a consistent v7 color language and safe fallbacks.

---

### 2.5 Dashboard — Portfolio Diagnostics (PATCHSET I)

**Files:**  
- `dashboard/utils/diagnostics_loaders.py`  
- `dashboard/diagnostics_panel.py` (NEW)  
- `dashboard/overview_panel.py`  
- `tests/test_portfolio_diagnostics_panel.py`

**What changed:**

- New loaders for `equity.json`, `positions.json`, and `pnl_attribution.json`.
- Diagnostics panel surfaces:
  - Current drawdown + worst-symbol snapshot
  - Daily return strip (approx. from equity)
  - Correlation view / fallback based on available data
  - Regime PnL bars (if attribution present)
- Integrated as a **Diagnostics** section or tab in the dashboard.

**Impact:**  
The dashboard now exposes **portfolio health, drawdown, daily volatility, and regime PnL** in one place without touching execution logic.

---

### 2.6 Strategy Weighting Engine (PATCHSET J)

**Files:**  
- `execution/position_sizing.py`  
- `execution/signal_screener.py`  
- `config/strategy_config.json`  
- `tests/test_adaptive_weighting.py`

**What changed:**

- Added `compute_strategy_performance_factor` and `compute_adaptive_weight`:
  - Combines:
    - risk_mode factor
    - ATR factor
    - DD factor
    - recent performance factor (e.g. winrate thresholds)
  - Clamps final weight between per-strategy min/max.
- Screener:
  - Loads `pnl_attribution.json`, regimes, and risk snapshot.
  - Computes `final_weight` per strategy and multiplies base gross notional before sizing.
  - Stamps `metadata.adaptive_weight` with weight + regime/risk context.
- Config:
  - New `strategy_weighting` / `strategy_adaptation` blocks for overrides, with safe defaults.

**Impact:**  
Strategies now have a **dynamic portfolio weight** that respects risk mode, volatility regimes, and recent performance, while still using the same unlevered sizing and risk veto stack.

---

## 3. Telemetry Surfaces Added / Extended

- `logs/state/pnl_attribution.json` (NEW)
- `logs/state/router_health.json` (extended with reliability + autotune metadata)
- `logs/state/pipeline_snapshot.json` (now capable of carrying adaptive metadata)
- Existing:
  - `equity.json` (unchanged but consumed by diagnostics)
  - `regimes.json`, `risk_snapshot.json` (used by adaptation / weighting)

All new fields are **additive and optional**. No existing schema keys were renamed.

---

## 4. Test Coverage & Status

New test files added:

- `tests/test_strategy_adaptation.py`  
- `tests/test_router_autotune.py`  
- `tests/test_pnl_attribution_core.py`  
- `tests/test_pnl_attribution_h2.py`  
- `tests/test_dashboard_attribution_panel.py`  
- `tests/test_portfolio_diagnostics_panel.py`  
- `tests/test_adaptive_weighting.py`  

All new suites pass alongside the existing v7 tests.  
The only warnings are pre-existing `PytestConfigWarning` about unknown config options (`env`).

---

## 5. Upgrade / Deployment Notes

1. **Config merge required**  
   - Ensure `config/strategy_config.json` is merged to include `strategy_adaptation` / `strategy_weighting` blocks.
   - Confirm per-strategy defaults (base_weight, min_weight, max_weight) are sane.

2. **State/telemetry directories**  
   - `logs/state/` must be writable by the executor and dashboard processes.
   - Verify new files (`pnl_attribution.json`, extended `router_health.json`) exist after one full execution loop.

3. **Dashboard reload**  
   - Restart dashboard service to pick up new panel modules.
   - Smoke test:
     - Overview loads
     - Attribution tab renders
     - Diagnostics tab renders
     - No crashes on missing telemetry.

4. **Risk invariants unchanged**  
   - `check_order()` and risk veto logic unchanged apart from prior normalization fixes.
   - NAV drawdown and daily-loss gates still enforced as before.
   - No change to leverage/sizing contracts.

---

## 6. Known Limitations (v7.2-alpha)

- PnL attribution:
  - Per-regime and per-risk-mode attribution assume a **single active regime/mode** at the time of trade; full historical regime replay is not yet implemented.
- Correlation:
  - Correlation view may be coarse/synthetic when time series are sparse.
- Adaptive weighting:
  - Uses simple threshold rules; no optimization or ML-based portfolio construction yet.

These are acceptable for v7.2-alpha and can be iterated in later sprints.

---

## 7. Next Steps / Candidate Work for Sprint 3

- Harden **PnL attribution** for longer histories & regime replay.
- Extend router autotune with **decay** and **per-symbol history windows**.
- Introduce **strategy-level risk budgets** tied directly into risk veto logic.
- Add **alerting** (Telegram/Slack) when:
  - router health collapses,
  - risk_mode escalates to DEFENSIVE/HALTED,
  - daily PnL breaches thresholds.

---

## 8. Tagging & Branching

Recommended tag:

```bash
git tag -a v7.2-alpha1 -m "Sprint 2 — Adaptive strategies, router autotune, PnL attribution, diagnostics, adaptive weighting"
git push origin v7.2-alpha1
