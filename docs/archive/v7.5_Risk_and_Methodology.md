## 9. Advanced Risk Layer (v7.5_A1)

v7.5 adds a formal **statistical risk layer** on top of the existing drawdown circuit and correlation caps.

### 9.1 Portfolio VaR (Parametric, EWMA)

We estimate **Value-at-Risk (VaR)** for the total portfolio using:

- Historical asset returns matrix
- An **EWMA covariance matrix** (λ ≈ 0.94, configurable)
- A confidence level (default 99%)

From this we derive:

- `portfolio_var_usd` — dollar loss threshold
- `portfolio_var_nav_pct` — VaR as a percentage of current NAV

We enforce a hard limit:

- `max_portfolio_var_nav_pct` (default 12%)

If the computed VaR exceeds this limit, the risk engine vetoes new orders with:

- `veto_reason = "portfolio_var_limit"`

This acts as a **forward-looking risk cap**, complementing the realised drawdown circuit.

---

### 9.2 Position CVaR Limits (Expected Shortfall)

For each open position, we estimate **Expected Shortfall (CVaR)** at 95% confidence.

Conceptually:

- VaR = “the 95th percentile loss”
- CVaR = “the *average* loss beyond that percentile”

For each symbol we compute:

- A loss distribution based on historical returns
- An approximate CVaR (using Gaussian ES scaling)
- CVaR as a percentage of NAV: `position_cvar_nav_pct`

We enforce:

- `max_position_cvar_nav_pct` (default 4% of NAV per position)

If a potential or existing position implies a CVaR above this threshold, the risk engine vetoes with:

- `veto_reason = "position_cvar_limit"`

This ensures **no single instrument** can dominate tail risk, even if raw notional and correlation caps would allow it.

---

### 9.3 Alpha-Decay Engine (Signal Half-Life)

Signals are not allowed to live forever.

We apply an **exponential time-decay** to the hybrid score:

- Each symbol has a `last_signal_ts`
- We compute elapsed time Δt in minutes
- Decay factor:

  \[
  \text{decay} = \exp\left(-\frac{\Delta t}{\text{half\_life\_minutes}}\right)
  \]

- Floor: `decay ≥ min_decay_multiplier` (e.g. 0.30)

Final hybrid score:

\[
\text{hybrid\_score\_decayed} = \text{hybrid\_score\_raw} \times \text{decay}
\]

Effect:

- Fresh signals ≈ unchanged
- Stale signals are **de-emphasised** automatically
- Prevents “ghost” trades based on outdated conditions

Combined with the volatility regime model and correlation caps, this produces an alpha surface that is:

- Time-aware  
- Regime-aware  
- Tail-aware  
- Portfolio-aware
