This is a *monster* upgrade. Weâ€™ve basically turned v7.3 into a proper v7.4 institutional engine with 159 tests backing it.

Letâ€™s lock this into docs so future-us (and investors) understand what weâ€™ve built.

Below are two drop-in docs you can literally save as-is:

* `docs/v7.4_Risk_and_Methodology.md`
* `docs/v7.4_Preflight_Runbook.md`

---

## 1ï¸âƒ£ `docs/v7.4_Risk_and_Methodology.md`

````markdown
# GPT-Hedge v7.4 â€” Risk & Methodology Sheet

Engine: **GPT-Hedge v7.4**  
Profile: **Institutional risk shell + hybrid alpha + regime-aware execution**

---

## 1. System Overview

The v7.4 engine trades crypto perpetual futures using:

- **Hybrid alpha** (trend + carry + expectancy + router quality)
- **Institutional risk controls** (portfolio DD circuit, correlation caps, NAV freshness)
- **Regime-aware sizing** via EWMA volatility states
- **Maker-first + TWAP execution** for large orders

All live trading flows must pass:

1. **Signal Screener** â†’ hybrid score + tier + regime
2. **Risk Engine v6** â†’ `risk_limits.check_order()`
3. **Router** â†’ maker-first / TWAP execution
4. **State Publisher** â†’ `logs/state/*.json` for dashboards and monitoring

---

## 2. Risk Stack

### 2.1 Portfolio Drawdown Circuit (A1)

**Purpose:** Hard stop at portfolio level to prevent cascading losses.

- Tracks NAV history (200+ last observations).
- Computes:
  - `peak_nav_usd`
  - `latest_nav_usd`
  - `current_dd_pct = (peak - latest) / peak`
- Config:
  - `risk_limits.json.circuit_breakers.max_portfolio_dd_nav_pct` (fraction, e.g. `0.10` = 10%)
- Behaviour:
  - If `current_dd_pct >= max_portfolio_dd_nav_pct`:
    - `risk_limits.check_order()` vetoes with `veto_reason = "portfolio_dd_circuit"`.
    - No new orders are allowed.
- Telemetry:
  - `risk.json`:
    - `portfolio_dd_pct`
    - `circuit_breaker.max_portfolio_dd_nav_pct`
    - `circuit_breaker.active` (bool)
- Dashboard:
  - Banner in risk panel: **CIRCUIT TRIPPED** when active.

**Interpretation:**  
This is the portfolio kill-switch â€” once tripped, the engine will not add risk until NAV recovers or config is changed.

---

### 2.2 Correlation Exposure Caps (A2)

**Purpose:** Prevent stacking risk across tightly correlated symbols (e.g. BTC/ETH/SOL).

- Config: `correlation_groups.json`:

  ```json
  {
    "groups": {
      "L1_bluechips": {
        "symbols": ["BTCUSDT", "ETHUSDT", "SOLUSDT"],
        "max_group_nav_pct": 0.35
      },
      "L2_alts": {
        "symbols": ["DOGEUSDT", "LINKUSDT", "LTCUSDT", "SUIUSDT", "WIFUSDT"],
        "max_group_nav_pct": 0.25
      }
    }
  }
````

* Logic:

  * Compute **gross group exposure**:

    * Sum of absolute notionals per group / total NAV.
  * For each proposed order:

    * Build **hypothetical** post-trade exposures.
    * If `hypothetical_group_exposure > max_group_nav_pct`:

      * Veto with `veto_reason = "correlation_cap"`.

* Telemetry:

  * `risk.json.correlation_groups`:

    * Per-group `gross_nav_pct` and `max_group_nav_pct`.

* Dashboard:

  * Table: group vs exposure vs cap with status:

    * ðŸŸ¢ `OK` (< 80% cap)
    * ðŸŸ¡ `NEAR` (80â€“100% cap)
    * ðŸ”´ `CAPPED` (exceeded; new orders blocked)

**Interpretation:**
We canâ€™t accidentally â€œgo all inâ€ on a theme by stacking similar coins; caps enforce portfolio diversification at the group level.

---

### 2.3 Other Risk Controls (pre-existing, still active)

* **Per-symbol NAV caps** (max NAV % per instrument).
* **NAV freshness veto** (stale NAV â†’ no new risk).
* **Min notional / step-size checks** (exchange-compliant).
* **Position TP/SL registry** (exit scanner bounded by registry).

`risk_limits.check_order()` remains the **single choke point** for order approval.

---

## 3. Hybrid Alpha Methodology (B1)

### 3.1 Components

For each symbol, we compute:

* **Trend Score** â€” medium-horizon technical signal (e.g. EMA / momentum / structure) in `[-1, +1]`.

* **Carry Score** â€” funding + basis:

  * Funding (perp funding rate, per 8h â†’ annualized).
  * Basis (spot-perp spread, typically annualized).
  * Both normalized and combined into `carry_score âˆˆ [-1, +1]`:

    * Positive: favourable carry (paid to hold)
    * Negative: expensive carry (paying to hold)

* **Expectancy Score** â€” statistical edge estimate (win rate, payoff ratios, etc. from backtests).

* **Router Quality Score** â€” execution quality metric (slippage, fill quality, maker ratio).

### 3.2 Hybrid Score

Base weights (example default):

* Trend: 40%
* Carry: 25%
* Expectancy: 20%
* Router Quality: 15%

Hybrid:

```text
hybrid_score = w_trend * trend_score
             + w_carry * carry_score
             + w_expect * expectancy_score
             + w_router * router_score
```

Clamped to `[-1, +1]`.

### 3.3 Tier Awareness

Tiers (CORE / SATELLITE / TACTICAL / ALT-EXT) adjust:

* Base `per_trade_nav_pct`
* Hybrid weights
* Minimum score thresholds

Config (`strategy_config.hybrid_scoring`):

* Per-tier weights override defaults.
* Direction-specific thresholds:

  * `min_hybrid_score_long`
  * `min_hybrid_score_short`

Screener:

* Ranks candidates by `hybrid_score`.
* Gating:

  * Longs must exceed `min_hybrid_score_long`.
  * Shorts must be below `-min_hybrid_score_short`.

---

## 4. Volatility Regime Model (B2)

### 4.1 EWMA Volatility

For each symbol:

* Compute log returns from price history.

* Compute **short** and **long** EWMA vol:

  * `vol_short` (e.g. 7-day EWMA)
  * `vol_long` (e.g. 30-day EWMA)

* Compute ratio:

  ```text
  ratio = vol_short / vol_long
  ```

### 4.2 Regime Classification

Using config thresholds (`vol_regimes.defaults.ratio_low_high`):

* `ratio < low`   â†’ `low` regime
* `low â‰¤ ratio < normal` â†’ `normal`
* `normal â‰¤ ratio < high` â†’ `high`
* `ratio â‰¥ high` â†’ `crisis`

We store:

* `vol_regime` âˆˆ {`low`, `normal`, `high`, `crisis`}
* `vol_short`, `vol_long`, `ratio`

### 4.3 Sizing Modulation

Per-tier config:

* `vol_regimes.sizing_multipliers[tier][regime]`:

  Example for CORE:

  * `low`:    1.15x base per-trade NAV
  * `normal`: 1.0x
  * `high`:   0.75x
  * `crisis`: 0.5x

Screener:

```text
effective_per_trade_nav_pct = base_per_trade_nav_pct * sizing_multiplier(tier, regime)
```

Risk caps still apply on top (per-symbol, group, portfolio DD).

### 4.4 Hybrid Weight Modulation

Regime also tweaks component weights:

* In `high` / `crisis`:

  * Downweight **carry** (funding can flip quickly).
  * Slightly downweight **expectancy**.
  * Optionally upweight **router quality** (execution matters more).

This is controlled via:

* `vol_regimes.hybrid_weight_modifiers[regime]`

---

## 5. Execution Methodology (C1)

### 5.1 Maker-First Routing

Baseline:

* Try to place maker orders around best bid/ask with offsets.
* Use taker fallback if:

  * Maker orders fail / timeout.
  * Signal is time-critical.

Metrics:

* Slippage vs mid.
* Maker vs taker ratio.

### 5.2 TWAP for Large Orders

For **large orders**:

* Config: `runtime.yaml.router.twap`:

  ```yaml
  router:
    twap:
      enabled: true
      min_notional_usd: 500.0
      slices: 4
      interval_seconds: 10
  ```

* If:

  * `enabled = True`
  * `gross_usd â‰¥ min_notional_usd`
  * `slices > 1`

  â†’ Use TWAP:

  * Split total quantity into `slices` child orders.
  * Auto-reduce slices if a child would violate **min notional**.
  * Each slice uses the **existing** maker-first routing.
  * Sleep `interval_seconds` between slices.

No additional risk checks here â€” the **full parent order** has already passed `risk_limits.check_order()`.

### 5.3 Execution Telemetry

* Events tagged with:

  * `execution_style = "single"` or `"twap"`

* TWAP events contain:

  * `slice_index`, `slice_count`
  * `slice_qty`, `parent_gross_usd`
  * Config snapshot (min_notional, slices, interval)

* Router metrics track:

  * `twap_trades_count` vs `single_trades_count`
  * `twap_avg_slippage_bps` vs `single_avg_slippage_bps`

---

## 6. State & Dashboard Contracts

### 6.1 State Files

Key state contracts:

* `logs/state/risk.json`:

  * `portfolio_dd_pct`
  * `circuit_breaker` (DD circuit)
  * `correlation_groups` (group exposures and caps)

* `logs/state/intel.json`:

  * Per symbol:

    * `trend_score`
    * `carry_score`
    * `hybrid_score`
    * `vol_regime` + `vol.short` / `vol.long` / `vol.ratio`

* `logs/state/router.json` (or equivalent router state):

  * Execution metrics (maker/taker, TWAP vs single).

### 6.2 Dashboard

Panels:

* **Risk Panel**:

  * Portfolio DD circuit status.
  * Correlation group exposure table.
* **Hybrid / Carry Panel**:

  * Per-symbol trend / carry / hybrid breakdown.
* **Vol Regimes Panel**:

  * Per-symbol regime badges.
  * Aggregate regime summary.
* **Execution Panel**:

  * TWAP vs single metrics (counts, average slippage).

---

## 7. Testing & Validation

Total tests (v7.4):

* A1 (DD Circuit): 49
* A2 (Correlation Caps): 19
* B1 (Carry/Hybrid Scoring): 25
* B2 (Vol Regime EWMA): 55
* C1 (TWAP Execution): 34

**Total: 159 tests â€” all passing.**

Test coverage includes:

* Core risk logic (DD + correlation + per-symbol).
* Hybrid scoring and ranking.
* Vol regime classification and sizing multipliers.
* TWAP eligibility, slicing, and event tagging.
* State publishing schemas.

---

## 8. Intended Use & Limits

* Designed for **crypto perpetual futures** with:

  * Reasonable liquidity.
  * Reliable funding and basis data.
* Not yet including:

  * Formal VaR / CVaR enforcement (design stubs next).
  * Options Greeks or cross-venue hedging.
  * Full walk-forward research pipeline in production (backtest pipelines are separate).

The v7.4 engine is suitable for:

* Smallâ€“medium institutional-style capital on testnet / early-mainnet.
* Demonstrating **risk discipline** and **methodological clarity** to investors.

````
