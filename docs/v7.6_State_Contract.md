# v7.6 State Contract — S0-A/B/C Consolidated

## Principles
- **Single writer per file** under `logs/state/` (executor owns all except `nav_state.json` mirrored by `sync_state.py`).
- **Atomic JSON** writes only; no partial/append semantics. Treat state as read-only everywhere else.
- **Minimal schemas enforced by smoke tests**; missing required keys fail `tests/integration/test_state_files_schema.py`.
- **Data hygiene**: non-zero positions must include entry/mark/PnL; NAV anomaly guard clamps spikes before drawdown math.

## Canonical Writers
| State File | Canonical Writer | Purpose |
|------------|-----------------|---------|
| `logs/state/nav.json` | `executor_live.py` → `state_publish.write_nav_state` | NAV totals + exec stats |
| `logs/state/nav_state.json` | `sync_state.py` | Dashboard-friendly NAV/AUM/drawdown snapshot |
| `logs/state/positions_state.json` | `executor_live.py` | Live positions (rows) with timestamps |
| `logs/state/positions_ledger.json` | `executor_live.py` | Merged ledger + TP/SL registry |
| `logs/state/risk_snapshot.json` | `executor_live.py` | Risk KPIs (dd_state, risk_mode, VaR/CVaR) |
| `logs/state/router_health.json` | `executor_live.py` | Router health/quality metrics |
| `logs/state/diagnostics.json` | `executor_live.py` | Runtime diagnostics (veto/exit/liveness) |
| `logs/state/factor_diagnostics.json` | `executor_live.py` | Factor weights/orthogonalization status |
| Mirrors: `kpis_v7.json`, `expectancy_v6.json`, `symbol_scores_v6.json`, `router_policy_suggestions_v6.json`, `risk_allocation_suggestions_v6.json` | `executor_live.py` | Derived KPIs/intel surfaces |

## Minimal Schemas (smoke rules)
- `nav_state.json`: must contain `total_equity`, `drawdown` (dashboard uses age_s/ts when present).
- `nav.json`: nav totals + `updated_ts`; may include `exec_stats`.
- `positions_state.json`: top-level `updated_at` plus `positions`/`rows` list; non-zero positions must include `entry_price`, `mark_price`, `pnl`.
- `positions_ledger.json`: `entries` map keyed by `symbol:side` with qty/entry_price/tp/sl.
- `risk_snapshot.json`: `updated_ts`, `risk_mode`, `dd_state`; enriched with VaR/CVaR/decay when available.
- `router_health.json`: router quality stats (maker/taker counts, fallbacks, scores).
- `diagnostics.json`: `runtime_diagnostics` block with `veto_counters`, `exit_pipeline`, `liveness` (see Runtime Diagnostics doc for fields).
- `factor_diagnostics.json`: factor diagnostics payload including orthogonality and weights.

## Telemetry & Test Hooks
- Schema smoke: `tests/integration/test_state_files_schema.py` validates required keys exist when files are present.
- Diagnostics contract: `tests/integration/test_veto_metrics.py`, `tests/integration/test_exit_pipeline_contract.py`, `tests/integration/test_state_publish_diagnostics.py`.
- Ledger/TP-SL contract: `tests/integration/test_state_publish_positions_ledger.py`, `tests/integration/test_exit_scanner.py`.
- NAV anomaly guard: `drawdown_tracker.compute_intraday_drawdown` clamps spikes; covered by `tests/integration/test_nav_anomaly_guard.py`.

## Guardrails
- Do not add secondary writers; if another view is required, write to a **new filename**.
- Keep fractions as decimals (0–1); avoid percent formatting in state.
- Prefer `state_publish` helpers for new fields to preserve atomic writes and consistent formatting.
