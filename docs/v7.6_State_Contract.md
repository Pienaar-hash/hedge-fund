# v7.6 State Contract

Single-writer, atomic JSON surfaces under `logs/state/`. Executor owns all except `nav_state.json` (sync_state mirror). Dashboard is read-only.

## Surfaces
| File | Path | Writer | Schema Highlights | Invariants |
|------|------|--------|-------------------|------------|
| `nav.json` | `logs/state/nav.json` | executor | `{nav, nav_usd, updated_ts, exec_stats}` | `updated_ts` present; numeric nav |
| `nav_state.json` | `logs/state/nav_state.json` | sync_state | dashboard nav/aum/drawdown | mirrors nav; has `total_equity`, `drawdown` |
| `positions_state.json` | `logs/state/positions_state.json` | executor | `{updated_at, positions:[{symbol, side, qty, entry_price, mark_price, unrealized_pnl, realized_pnl, notional}]}` | non-zero qty → entry_price>0, mark_price>0 |
| `positions_ledger.json` | `logs/state/positions_ledger.json` | executor | `{updated_at, entries:[{symbol, side, qty, entry_price, tp, sl, created_ts, updated_ts}], tp_sl_levels:{}, metadata}` | written every loop; entries list always present |
| `kpis_v7.json` | `logs/state/kpis_v7.json` | executor | `{updated_at, portfolio:{nav, dd_pct, var_nav_pct, cvar_nav_pct}, per_symbol:{...}}` | `updated_at` required |
| `diagnostics.json` | `logs/state/diagnostics.json` | executor | `{runtime_diagnostics:{veto_counters, exit_pipeline, liveness}}` | liveness has `details`+`missing`; exit has coverage % + router ts |
| `risk_snapshot.json` | `logs/state/risk_snapshot.json` | executor | risk KPIs incl. `risk_mode`, `dd_state`, VaR/CVaR blocks | `updated_ts` required |
| `router_health.json` | `logs/state/router_health.json` | executor | `router_health:{global{quality_score,buckets,slippage,latency,twap_usage_ratio},per_symbol{quality_score,avg_slippage_bps,avg_latency_ms,twap_usage_ratio,child_orders}}` | `updated_ts` required; `router_health.global` present; `per_symbol` object (may be empty) |
| `symbol_scores_v6.json` | `logs/state/symbol_scores_v6.json` | executor | per-symbol scores with `hybrid_score`, `hybrid{router_quality_score,passes_emission,min_for_emission}` | optional, per intel run |
| `rv_momentum.json` | `logs/state/rv_momentum.json` | executor | RV momentum snapshot | optional, per intel run |
| `factor_diagnostics.json` | `logs/state/factor_diagnostics.json` | executor | factors, covariance, orthogonalization, weights | optional, per intel run |

## Rules
- Atomic writes only (temp + replace).
- One canonical writer per file; no secondary writers.
- Missing files must be tolerated by loaders; schema keys enforced by integration tests.
- New state surfaces must be added to `v7_manifest.json` with path/owner/description.

### factor_diagnostics.json (v7.6)
- `updated_ts` always present.
- `raw_factors`: keyed by `SYMBOL:DIRECTION`, with `{factors, direction, regime}`.
- `per_symbol`: normalized factors keyed by `SYMBOL:DIRECTION`.
- `normalization_coeffs`: per-factor stats (`mean`, `std`, `min`, `max`, `range`).
- `covariance`: `{factors, covariance_matrix, correlation_matrix, factor_vols, lookback_days}`.
- `orthogonalized`: `{per_symbol, norms, dot_products, degenerate}` (Gram–Schmidt output).
- `factor_ir`: IR surface chosen from PnL or observed factor vectors.
- `weights`: normalized, clamped, smoothed weights (also mirrored under `factor_weights.weights` for legacy readers).
- `pnl_attribution`: `{window_days, by_factor, factor_ir, weights, orthogonalized_summary?}`.
- `orthogonalization_enabled` / `auto_weighting_enabled` flags + config echo for observability.

### nav.json / nav_state.json
- `nav.json`: `{nav, nav_usd, updated_ts, exec_stats?}` written every loop; nav must be numeric and non-null.
- `nav_state.json`: dashboard mirror with `{total_equity/nav/nav_usd, drawdown?, updated_ts, aum}`; tolerate stale/missing fields but emit last-known-good when available.

### risk_snapshot.json (v7.6)
- Required keys: `updated_ts`, `risk_mode`, `dd_state`, `circuit_breaker`, `anomalies`, `nav/nav_total`.
- VaR/CVaR blocks include limits and within_limit flags; anomalies may surface `nav_jump`, `var_limit_breach`, `cvar_limit_breach`, `dd_flap`.
- `dd_state` reflects portfolio drawdown state (NORMAL/DRAWDOWN/RECOVERY) with `drawdown.dd_pct` present.

### Timestamp & Freshness
- All executor surfaces must include `updated_ts` (or `updated_at` alias) per write.
- `nav_state.json` mirrors `nav.json` and must not be newer than `nav.json`’s timestamp.
- Dashboard loaders treat missing/stale surfaces as soft failures; schema tests enforce presence of required keys.
### diagnostics.json → runtime_diagnostics.exit_pipeline
- Always populated per loop.
- Fields: `last_exit_scan_ts`, `last_exit_trigger_ts`, `last_router_event_ts`,
  `open_positions_count`, `tp_sl_registered_count`, `tp_sl_missing_count`,
  `underwater_without_tp_sl_count`, `tp_sl_coverage_pct`, `ledger_registry_mismatch`.
- `mismatch_breakdown`: counts for `missing_ledger_positions`, `ghost_ledger_entries`, `missing_tp_sl_entries`, `stale_tp_sl_entries` (optional but emitted when available).
