# v7.6 Architecture — Single Source of Truth

## Runtime Topology
- **Executor** (`execution/executor_live.py`): Screener → Risk → Router → Exchange. Owns all canonical state writers except nav_state mirror.
- **State Publish** (`execution/state_publish.py`): Atomic JSON writers for nav/risk/router/positions/factor intel/diagnostics. Central helper used by executor.
- **Sync State** (`execution/sync_state.py`): Read-only mirror for dashboard (writes `nav_state.json` only; mirrors other files without taking ownership).
- **Risk Layer** (`execution/risk_limits.py`, `execution/risk_engine_v6.py`): NAV freshness, drawdown/daily-loss circuits, per-symbol/portfolio caps, correlation caps, VaR/CVaR checks, nav anomaly guard in `drawdown_tracker.compute_intraday_drawdown`.
- **Routing Layer** (`execution/order_router.py` + `execution/intel/*`): Maker-first with adaptive offsets and TWAP; fallback to taker under spread/slip bounds; logs router metrics.
- **Exit Layer** (`execution/exit_scanner.py`, `execution/position_ledger.py`, `execution/position_tp_sl_registry.py`): Combines ledger + TP/SL registry to trigger exits and record exit diagnostics.
- **Diagnostics** (`execution/diagnostics_metrics.py`): Veto counters, exit pipeline status, liveness watchers; persisted to `diagnostics.json`.
- **Dashboard** (`dashboard/*.py`, `dashboard/state_v7.py`): Streamlit panels consuming state files via normalized loaders.

## End-to-End Flow
1) **Intent build** in `signal_screener.py`: unlevered sizing (gross_usd) + leverage metadata, universe/tier gating.
2) **Risk vetting** in `risk_limits.check_order` orchestrated by `risk_engine_v6.py`: nav age, drawdown/daily-loss, per-trade nav %, per-symbol/tier caps, portfolio caps, correlation/VAR/CVAR guards; veto reasons emitted.
3) **Routing** in `order_router.route_intent`: maker-first submit, post-only retries, fallback to taker; chunking via min child notional; fill monitoring; metrics logged.
4) **Exit pipeline** in `exit_scanner.scan_tp_sl_exits`: ledger + TP/SL registry merged, underwater-without-TP/SL check; triggers exits and updates diagnostics.
5) **Telemetry/state** via `state_publish`: writes nav/risk/router/positions/diagnostics/factor intel; `sync_state` mirrors for dashboard; dashboard renders via `state_v7` loaders.

## State Surfaces (canonical writers)
- `logs/state/nav.json` — `executor_live.py` via `write_nav_state` (nav totals + exec stats).
- `logs/state/nav_state.json` — `sync_state.py` mirror (nav/AUM/drawdown snapshot for dashboard).
- `logs/state/positions_state.json` — `executor_live.py` (live positions; single writer enforced).
- `logs/state/positions_ledger.json` — `executor_live.py` (ledger + TP/SL merge).
- `logs/state/risk_snapshot.json` — `executor_live.py` (`write_risk_snapshot_state` enriched with dd_state/VAR/CVAR).
- `logs/state/router_health.json` — `executor_live.py` (`write_router_health_state`).
- `logs/state/diagnostics.json` — `executor_live.py` (`write_runtime_diagnostics_state` liveness/veto/exit data).
- `logs/state/factor_diagnostics.json` — `executor_live.py` (factor weights/orthogonalization).
- Additional mirrors: `kpis_v7.json`, `expectancy_v6.json`, `symbol_scores_v6.json`, `router_policy_suggestions_v6.json`, `risk_allocation_suggestions_v6.json`.

## Config Surfaces
- `config/strategy_config.json` — strategy params, per_trade_nav_pct, diagnostics (veto/exit/liveness) thresholds.
- `config/risk_limits.json` — fractional caps, nav anomaly guard, per-symbol/tier caps, correlation/VaR/CVaR knobs.
- `config/runtime.yaml` — router offsets/post-only/defaults, min child notional, fill windows, fee bps.
- `config/pairs_universe.json`, `config/symbol_tiers.json` — universe + tiers; `config/settings.json`, `config/offexchange_holdings.json` for treasury/AUM.

## Observability & Invariants
- **Diagnostics**: veto heatmap, exit pipeline coverage, liveness flags written every executor loop.
- **Telemetry logs**: JSONL under `logs/execution/` (`orders_executed.jsonl`, `order_metrics.jsonl`, `risk_vetoes.jsonl`); state JSON under `logs/state/`.
- **Contracts**: single-writer per state file, atomic JSON writes, non-zero positions must include entry/mark/PnL, NAV anomaly guard clamps spikes before drawdown math.
- **Smoke tests**: `tests/integration/test_state_files_schema.py` enforces required keys; diagnostics/state tests cover veto metrics, exit flow, and `diagnostics.json` schema.
