# v7.6 Incident Playbooks

These playbooks align with the v7.6 state/diagnostics contract. Always start with `logs/state/diagnostics.json` (veto + exit + liveness) and `logs/execution/*.jsonl` tails.

## Positions Stuck / No New Trades
- **Symptoms**: open positions static; no new orders; TP/SL not firing.
- **Checks**:
  - `risk_snapshot.json`: `risk_mode`, `dd_state`, daily-loss/drawdown circuits.
  - `positions_state.json`: non-zero entries have entry/mark prices; timestamps advancing.
  - `diagnostics.json` → `veto_counters` for dominant gate; `exit_pipeline` counts.
  - Ledger vs registry: `positions_ledger.json` vs `position_tp_sl.json` counts.
- **Actions**:
  - If veto-heavy (`max_concurrent`, `symbol_cap`, `portfolio_dd_circuit`), adjust config only if intentional; otherwise restart executor after config fix.
  - Missing TP/SL: run `scripts/seed_exit_registry_from_open_positions.py` or rebuild ledger.
  - Stale timestamps or liveness idle flags → restart executor; verify `diagnostics.json` timestamps tick.

## NAV Spikes / Drawdown Whiplash
- **Symptoms**: sudden NAV jump causing false recoveries or DD resets; router/risk toggling unexpectedly.
- **Checks**:
  - `nav_state.json` vs `nav.json` — compare `total_equity`/`drawdown` to recent values.
  - Risk config: `risk_limits.json -> nav_anomalies` (`enabled`, `max_multiplier_intraday`, `max_gap_abs_usd`).
  - Logs: `logs/execution/risk_vetoes.jsonl` for drawdown circuit chatter.
- **Actions**:
  - Tighten `nav_anomalies` thresholds temporarily; confirm `drawdown_tracker.compute_intraday_drawdown` is invoked (check tests/integration/test_nav_anomaly_guard.py).
  - If exchange glitch suspected, pin nav to last good snapshot and rerun executor once; monitor `nav_state.json` stability.

## Stalled Exit Pipeline
- **Symptoms**: exits not triggering; underwater positions without TP/SL; liveness idle_exits true.
- **Checks**:
  - `diagnostics.json` → `exit_pipeline` counts and timestamps; `underwater_without_tp_sl_count`.
  - `positions_ledger.json` vs `position_tp_sl.json` coverage.
  - `logs/execution/orders_executed.jsonl` for recent CLOSE events.
- **Actions**:
  - Seed registry (`scripts/seed_exit_registry_from_open_positions.py`) and rebuild ledger.
  - Verify price feed to exit scanner (spot price map) is live; restart executor if timestamps stale.
  - After recovery, ensure `last_exit_scan_ts`/`last_exit_trigger_ts` advance and `tp_sl_missing_count` drops.

## Screener → Risk → Router Stalls
- **Symptoms**: liveness idle_signals/idle_orders/idle_router true; no recent vetoes or orders.
- **Checks**:
  - `diagnostics.json` liveness flags and `details` durations.
  - Screener logs (`logs/exec.log` or equivalent) for fetch or universe resolution errors.
  - Veto heatmap: if zero orders but rising vetoes, risk clamp is blocking flow.
- **Actions**:
  - Restart executor; confirm new timestamps for signals/orders.
  - If veto-heavy, review `risk_limits.json` and `strategy_config.json` sizing caps; correct configuration and redeploy.
  - Validate runtime config (`config/runtime.yaml`) for router min child notional vs intent size; adjust if intents too small to route.

## Telemetry Corruption / Bad State Files
- **Symptoms**: dashboard errors when loading state; JSON decode errors; schema smoke tests failing.
- **Checks**:
  - Validate JSON with `python -m json.tool logs/state/<file>.json`.
  - Ensure only canonical writers are active (see v7.6_State_Contract); no ad-hoc scripts writing to `logs/state`.
  - `tests/integration/test_state_files_schema.py` to reproduce schema gaps locally.
- **Actions**:
  - Remove/rotate corrupted file backups, then let executor republish; never manually edit state in place.
  - If sync_state is overwriting canonical files, restrict it to mirrors; keep executor as sole writer.
  - Add missing fields in publishers and loaders, extend schema test, rerun `make test`.
