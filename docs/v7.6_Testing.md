# v7.6 Testing

## Lanes
- `tests/unit/` — pure/fast logic; default discovery.
- `tests/integration/` — runtime/state/dashboard/telemetry contracts; default discovery.
- `tests/legacy/` — v5/v6 references, marked `legacy` and skipped by default.

## Canonical Commands
- **Green bar**: `make test` (runs `PYTHONPATH=. pytest tests/unit tests/integration -q`).
- **Runtime-only slice**: `PYTHONPATH=. pytest -m runtime -q` (state/telemetry/schema checks).
- **Include legacy**: `PYTHONPATH=. pytest tests/legacy -m legacy -q`.

## Markers (pytest.ini)
- `legacy` — legacy suite, opt-in.
- `runtime` — telemetry/state schema/diagnostics checks.

## Critical Contracts Covered
- **State schema**: `tests/integration/test_state_files_schema.py` (required keys for nav_state/positions_state/risk_snapshot/diagnostics).
- **Diagnostics**: `tests/integration/test_veto_metrics.py`, `tests/integration/test_exit_pipeline_contract.py`, `tests/integration/test_state_publish_diagnostics.py`.
- **NAV guards**: `tests/integration/test_nav_anomaly_guard.py`, `tests/integration/test_nav_age.py`, `tests/integration/test_nav_fail_closed.py`.
- **Position/ledger surfaces**: `tests/integration/test_state_publish_positions_ledger.py`, `tests/integration/test_state_positions_contract.py`, `tests/integration/test_exit_scanner.py`.
- **Router/risk invariants**: `tests/integration/test_risk_limits*.py`, `tests/integration/test_router_*`, `tests/integration/test_order_router_*`.

## Long-Running / External
- Firestore/Telegram: `tests/integration/test_firestore_*`, `tests/integration/test_telegram_*` (require credentials, may be skipped locally).
- Pipeline shadow/compare: `tests/integration/test_pipeline_v6_shadow.py`, `test_pipeline_v6_compare_runtime.py` — heavier, isolate when needed.
- Router autotune apply: `tests/integration/test_router_autotune_apply_v6.py` — relies on recorded fixtures; keep deterministic.

## Expectations
- Set `PYTHONPATH=.` for all runs.
- Keep new tests fast and deterministic; prefer unit lane unless state/telemetry contract is involved.
- When adding state fields, extend integration tests + `dashboard/state_v7.py` loaders to keep the schema contract stable.
