# v6 State Contract (logs/state)

## Shared guarantees
- All writers call `_write_state_file()` (`execution/state_publish.py:77-140`), which writes to `<name>.tmp` then `replace()` to avoid partial files.
- Timestamps are ISO8601 strings (NAV series) or epoch floats (intel/risk snapshots). Writers rely on `_now_iso()`/`time.time()` to keep everything UTC.
- Consumers must treat every payload as authoritative; there is no secondary data store. Sync, dashboard, CLI probes, and tests all read these files directly.

## File-by-file schema
### `nav.json`
- Produced via `_commit_nav()` (`execution/sync_state.py:1085-1102`) after filtering nav rows and computing drawdown.
- Fields:
  - `series`: list of `{equity, nav, pnl, realized_pnl, t}` entries trimmed to `MAX_POINTS`.
  - `peak_equity`: float from `_compute_peak_from_rows()`.
  - `updated_at`: ISO timestamp of last point.
  - `total_equity`, `portfolio_gross_usd`, `net_exposure_usd`, `largest_position_usd` appended from `_read_nav_tail_metrics()` + `_exposure_from_positions()` (`execution/sync_state.py:1003-1015`).
  - Drawdown extras `drawdown_pct`, `drawdown_abs`, `realized_pnl_today`, `peak_equity` injected via `compute_intraday_drawdown()` (`execution/sync_state.py:1196-1218`).

### `positions.json`
- `write_positions_state()` (`execution/state_publish.py:94-110`) stores `{items, updated_at, gross_exposure_usd, net_exposure_usd, largest_position_usd}`.
- `items` are normalized by `_normalize_positions_items()` (`execution/sync_state.py:970-997`): each row contains `{symbol, side, qty, entry_price, mark_price, pnl, leverage, notional, ts}`.

### `synced_state.json`
- Built by `build_synced_state_payload()` (`execution/state_publish.py:153-190`) using executor tick rows.
- Shape: `{items: [raw positions dicts], nav: float, engine_version: str, v6_flags: {flag: bool}, updated_at: float}`. Tests `tests/test_executor_state_files.py:1-38` assert this contract.

### `risk_snapshot.json`
- Generated by `_maybe_emit_risk_snapshot()` (`execution/executor_live.py:280-309`): either from `RiskEngineV6.build_risk_snapshot()` (`execution/risk_engine_v6.py:84-114`) or `execution.utils.execution_health.compute_execution_health()` (`execution/utils/execution_health.py:1-110`).
- Contains `symbols: [{symbol, router:{maker_fill_ratio,fallback_ratio,slip_q50,router_warnings,...}, risk:{dd_today_pct,risk_flags,sharpe_state}, vol:{atr_now,atr_regime}, sizing:{size_mult_sharpe,final_size_factor}, updated_ts}]` plus a `updated_ts` root timestamp.

### `router_health.json`
- `_build_router_health_snapshot()` (`execution/executor_live.py:152-193`) loops every enabled symbol, merging router effectiveness metrics (`execution/utils/metrics.py:73-145`) with `router_policy()` outputs (`execution/intel/router_policy.py:1-120`).
- Schema: `{updated_ts, symbols:[{symbol, maker_fill_rate, fallback_rate, slippage_p50, slippage_p95, policy:{maker_first,taker_bias,quality,reason}}]}` plus optional `maker_offset_bps`.

### `expectancy_v6.json`
- Built in `execution/intel/expectancy_v6.py:260-333` after merging fills + router metrics.
- Structure: `{symbols:{SYMBOL:{count, hit_rate, avg_win, avg_loss, expectancy, expectancy_per_risk, drawdown_adjusted}}, hours:{0..23: expectancy}, regimes:{regime_name: expectancy}, sample_count:int, lookback_hours:float, metadata:{nav_snapshot}, updated_ts}`.

### `symbol_scores_v6.json`
- Produced by `execution/intel/symbol_score_v6.py:1-137`.
- Schema: `{updated_ts, symbols:[{symbol, score, components:{expectancy, router, slippage_penalty, fee_drag_penalty, volatility_penalty}, inputs:{expectancy:{...}, router:{...}}]}`.

### `router_policy_suggestions_v6.json`
- `execution/intel/router_autotune_v6.py:1-200` outputs `{generated_ts, lookback_days, symbols:[{symbol, regime, quality, current_policy:{maker_first,taker_bias,bias_label,offset_bps}, proposed_policy:{...}, rationale:[], expectancy_inputs, score_inputs}]}`. Tests in `tests/test_router_autotune_v6.py:1-60` validate bias/offset bounds.

### `risk_allocation_suggestions_v6.json`
- `execution/intel/feedback_allocator_v6.py:260-402` returns `{generated_ts, lookback_days, global:{current_equity_usd,current_drawdown_pct,risk_mode}, symbols:[{symbol,score,expectancy,router_policy,caps,suggested_caps,suggested_weight,rationale}]}`. Tests `tests/test_feedback_allocator_v6.py:1-120` cover scaling behavior.

### Pipeline state files
- `pipeline_v6_shadow_head.json`: summarises `logs/pipeline_v6_shadow.jsonl` via `scripts/pipeline_shadow_heartbeat.py:1-38` and `execution/pipeline_v6_shadow.build_shadow_summary()`.
- `pipeline_v6_compare_summary.json`: `execution/intel/pipeline_v6_compare.py:1-98` writes comparison stats (`sample_size`, `veto_mismatch_pct`, `size_diff_stats`, `slippage_diff_bps`) plus `generated_ts`.

### `v6_runtime_probe.json`
- `write_v6_runtime_probe_state()` stores `{INTEL_V6_ENABLED, RISK_ENGINE_V6_ENABLED, PIPELINE_V6_SHADOW_ENABLED, ROUTER_AUTOTUNE_V6_ENABLED, FEEDBACK_ALLOCATOR_V6_ENABLED, ROUTER_AUTOTUNE_V6_APPLY_ENABLED, ENV, DRY_RUN, BINANCE_TESTNET, ts}` per `_runtime_context()` in `execution/v6_flags.py:83-97`.

## Validation
- State schema stability is enforced by `tests/test_executor_state_files.py:1-38`, `tests/test_pipeline_v6_shadow.py:1-64`, `tests/test_pipeline_v6_compare_runtime.py:1-33`, and `tests/test_v6_runtime_activation.py:1-30`.
- Dashboard/template consumers (`dashboard/app.py:1-130`, `scripts/expectancy_v6_builder.py:1-39`, `scripts/router_autotune_v6_probe.py:1-78`, `scripts/feedback_allocator_probe_v6.py:1-70`) all import the same writers, guaranteeing parity between background jobs and manual probes.
