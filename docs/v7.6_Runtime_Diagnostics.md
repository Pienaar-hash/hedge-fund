# v7.6 Runtime Diagnostics

## Surfaces
- **`logs/state/diagnostics.json`** — persisted every executor loop via `write_runtime_diagnostics_state` (single writer).
- **Dashboard panels** — veto heatmap, exit pipeline health, and liveness tiles rendered from `diagnostics.json` (`risk_panel.py`).
- **Config knobs** — `strategy_config.json -> diagnostics`:
  - `veto_metrics.window_signals/window_seconds`
  - `exit_pipeline.tp_sl_canary_enabled`, `tp_sl_underwater_threshold_pct`
  - `liveness.enabled`, `max_idle_signals_seconds`, `max_idle_orders_seconds`, `max_idle_exits_seconds`, `max_idle_router_events_seconds`

## Data Model (`diagnostics.json`)
```json
{
  "runtime_diagnostics": {
    "veto_counters": {
      "by_reason": {"portfolio_dd_circuit": 3, "symbol_cap": 1},
      "total_signals": 12,
      "total_orders": 7,
      "total_vetoes": 4,
      "last_signal_ts": "2024-02-01T10:00:00Z",
      "last_order_ts": "2024-02-01T10:00:30Z",
      "last_veto_ts": "2024-02-01T10:00:29Z"
    },
    "exit_pipeline": {
      "last_exit_scan_ts": "2024-02-01T10:00:00Z",
      "last_exit_trigger_ts": "2024-02-01T10:00:05Z",
      "open_positions_count": 4,
      "tp_sl_registered_count": 3,
      "tp_sl_missing_count": 1,
      "underwater_without_tp_sl_count": 1
    },
    "liveness": {
      "idle_signals": false,
      "idle_orders": false,
      "idle_exits": false,
      "idle_router": false,
      "details": {
        "signals_idle_seconds": 12.0,
        "orders_idle_seconds": 30.0,
        "exits_idle_seconds": 45.0,
        "router_idle_seconds": 30.0
      }
    }
  }
}
```

## How it is produced
- **Veto counters**: `execution/diagnostics_metrics.record_signal_emitted`, `record_order_placed`, `record_veto` called from screener/risk/router paths. Consumed by dashboard as veto heatmap.
- **Exit pipeline**: `exit_scanner.scan_tp_sl_exits` merges `position_ledger` + `position_tp_sl_registry`, counts TP/SL coverage, flags underwater positions without TP/SL, and records last scan/trigger timestamps.
- **Liveness**: `compute_liveness_alerts` compares last signal/order/exit/router events against thresholds from config; flags set in `liveness` block.

## Operational Use
- **Heatmap triage**: spike in a single veto reason = config bug or risk clamp; adjust `risk_limits.json`/`strategy_config.json` only if intentional.
- **Exit health**: `tp_sl_missing_count` > 0 or `underwater_without_tp_sl_count` > 0 should trigger registry seeding (`scripts/seed_exit_registry_from_open_positions.py`) or ledger rebuild before trading.
- **Idle alerts**: any `idle_*` true → executor is stuck (signals/orders/exits/router); restart executor and confirm timestamps advance.

## Tests / Guardrails
- `tests/integration/test_veto_metrics.py` — counters accumulate correctly.
- `tests/integration/test_exit_pipeline_contract.py` — TP/SL coverage + underwater detection wired to diagnostics.
- `tests/integration/test_state_publish_diagnostics.py` — `diagnostics.json` schema and persistence.
- Dashboard rendering paths in `dashboard/risk_panel.py` expect fields above; keep schema backward compatible.
