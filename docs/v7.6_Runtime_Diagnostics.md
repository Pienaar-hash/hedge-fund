# v7.6 Runtime Diagnostics

Single writer: `executor_live` â†’ `logs/state/diagnostics.json` via `write_runtime_diagnostics_state`.

## Payload
```json
{
  "runtime_diagnostics": {
    "veto_counters": {
      "by_reason": {"symbol_cap": 1},
      "total_signals": 12,
      "total_orders": 7,
      "total_vetoes": 3,
      "last_signal_ts": "2025-01-01T00:00:01Z",
      "last_order_ts": "2025-01-01T00:00:02Z",
      "last_veto_ts": "2025-01-01T00:00:03Z"
    },
    "exit_pipeline": {
      "last_exit_scan_ts": "2025-01-01T00:00:00Z",
      "last_exit_trigger_ts": "2025-01-01T00:00:05Z",
      "last_router_event_ts": "2025-01-01T00:00:04Z",
      "open_positions_count": 4,
      "tp_sl_registered_count": 3,
      "tp_sl_missing_count": 1,
      "underwater_without_tp_sl_count": 1,
      "tp_sl_coverage_pct": 0.75,
      "ledger_registry_mismatch": true,
      "mismatch_breakdown": {
        "missing_ledger_positions": 0,
        "ghost_ledger_entries": 0,
        "missing_tp_sl_entries": 1,
        "stale_tp_sl_entries": 0
      }
    },
    "liveness": {
      "idle_signals": false,
      "idle_orders": false,
      "idle_exits": false,
      "idle_router": false,
      "details": {
        "signals_idle_seconds": 12.0,
        "orders_idle_seconds": 30.0,
        "exits_idle_seconds": 45.0,
        "router_idle_seconds": 30.0
      },
      "missing": {
        "signals_idle_seconds": false,
        "orders_idle_seconds": false,
        "exits_idle_seconds": false,
        "router_idle_seconds": false
      }
    }
  }
}
```

## Semantics
- **Veto counters**: incremented by screener/risk/router hooks; timestamps updated on emit.
- **Exit pipeline**: counts coverage, mismatch, underwater-without-TP/SL; records last exit scan/trigger and last router event (router updates this on send/fill/cancel).
  - `mismatch_breakdown` surfaces counts for missing ledger entries, ghost ledger rows, missing TP/SL, stale registry entries.
  - Stale/missing surfaces should be treated as soft failures and surfaced as warnings in the dashboard/system health panel.
- **Liveness**:
  - Thresholds from `config/strategy_config.json -> diagnostics.liveness`.
  - Missing timestamps treated as idle; flagged in `missing` and `details` (threshold+1).
  - Negative deltas clamped to 0.
  - `details.router_idle_seconds` always reflects time since `last_router_event_ts`, even if router idle threshold is disabled.

## Dashboard Rendering
- Veto heatmap: from `veto_counters.by_reason`.
- Exit health: shows coverage %, mismatch flag, last scan/trigger/router ts, underwater count.
- Liveness: idle flags drive warning; durations formatted; missing timestamps listed for components that never emitted.

## Invariants
- Written every executor loop; atomic write.
- No other module writes `diagnostics.json`.
- Loaders must tolerate missing/partial blocks.
