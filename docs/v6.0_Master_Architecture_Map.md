# **v6.0 Architecture Map (Full System Blueprint)**

## **Reality Check**

- **Current live-state:** See `docs/ARCHITECTURE_CURRENT.md` for the v5.10/v6-pre topology snapshot produced in Batch 0.
- **Detailed audit:** `docs/infra_v6.0_repo_topology.md` remains the authoritative point-in-time survey of repo structure, gaps, and remediation batches.

## **1. Execution Engine (Core Live Trading Layer)**

_Status: present but misaligned — reference `docs/ARCHITECTURE_CURRENT.md` §§1–2 and `docs/infra_v6.0_repo_topology.md` §2.1 for current executor/sizer/router behavior._

### **1.1 Live Executor**

* Orchestrates signal polling, intent generation, risk gating, router selection, order submission, and position/state publishing.
* Components:

  * `executor_live.py`
  * Unified intent → risk → sizing → router → order pipeline
  * Health telemetry (latency, slip, gate outcomes)
  * Dual-mode: PRODUCTION (ALLOW_PROD_WRITE=1), DRY-RUN

### **1.2 Size Model**

* Deterministic, config-driven sizing engine.
* Inputs: NAV, price, volatility features, per-symbol caps.
* Outputs: USD notional, side, leverage, quantity.
* Modules:

  * `execution/size_model.py`
  * `execution/position_math.py`

### **1.3 Exchange Adapters**

* Binance USD-M futures wrapper:

  * Market, limit, stop placement
  * Position query
  * Order filters / min-notional normalization
* Hardened payload cleaner (whitelist-only)
* Modules:

  * `execution/exchange_utils.py`

### **1.4 Router Policy + Order Router**

* Maker/taker routing logic
* Adaptive offset calculation
* Router health inference
* Per-symbol policy engine (good/broken/bad)
* Modules:

  * `execution/order_router.py`
  * `execution/intel/router_policy.py`

---

## **2. Strategy Layer**

_Status: partial — registry/config files exist but there is no `strategies/` package; see `docs/ARCHITECTURE_CURRENT.md` §3 and `docs/infra_v6.0_repo_topology.md` §2.2._

### **2.1 Strategy Registry**

* Declares enabled strategies and their metadata.
* Lives in:

  * `config/strategy_registry.json`

### **2.2 Strategy Config**

* Defines:

  * Symbol universe
  * Per-strategy caps
  * Concurrency
  * Leverage & max_nav_pct
  * Volatility buckets
  * Signal granularity
* Location:

  * `config/strategy_config.json`

### **2.3 Strategy Implementations**

* Momentum (1h)
* Vol-target (4h)
* Relative Value (1d)
* ICT-style Smart-Money Concepts (optional module in v6)
* RL/ML layers integrated via screener hooks
* Module directory:

  * `strategies/…`

---

## **3. Screener + Intent Layer**

### **3.1 Screener Engine**

* Multi-symbol feature scanner:

  * OB/LOB features
  * Volatility filters
  * Trend regime detection
  * ML predictions (optional)
* Emits *proto-intents* only.

### **3.2 Intent Builder**

* Converts screener outputs into structured intents.
* Enforces:

  * trade_nav_percentage
  * max_trade_nav_pct
  * max_concurrent_positions
  * per-symbol concurrency slots

### **3.3 Risk-Aware Screener**

* Pre-checks risk constraints before calling `check_order`.
* Records structured veto metadata:

  * trade_gt_nav_pct
  * leverage_exceeded
  * min_notional
  * symbol exposure
  * global exposure
  * cooldown triggers

Modules:

* `execution/signal_screener.py`
* `execution/signal_doctor.py`

---

## **4. Risk Engine**

_Status: present but missing object model — module-level gates exist yet the `RiskEngine` class is not implemented (`docs/ARCHITECTURE_CURRENT.md` §3; `docs/infra_v6.0_repo_topology.md` §2.1 & §6)._

### **4.1 Global Risk System**

* NAV-based gating
* Daily loss limit
* Gross exposure cap
* NAV freshness gating
* Drawdown gating

### **4.2 Per-Symbol & Per-Strategy Limits**

* Max leverage
* Max order notional
* Max NAV %
* Cooldowns
* Concurrency caps

### **4.3 Risk State Persistence**

* Warm-start from caches
* Cooldown timers
* Previous veto reasons
* Trigger windows

Modules:

* `execution/risk_limits.py`
* `cache/risk_state.json`

---

## **5. State + Telemetry Layer**

_Status: degraded — telemetry files exist but publishers/syncers are stubs per `docs/ARCHITECTURE_CURRENT.md` §3 and `docs/infra_v6.0_repo_topology.md` §§2.1, 4._

### **5.1 Telemetry Files**

* `positions.json`
* `orders.jsonl`
* `risk_vetoes.jsonl`
* `router_health.json`
* `nav_log.json`

### **5.2 Sync Daemon**

* Mirrors local state to cloud (Firestore or S3 in v6)
* Provides “single source of truth” for dashboard

### **5.3 Health Monitoring**

* Executor heartbeat
* Sync-state heartbeat
* Router offset logs
* Gating logs
* NAV freshness logs

Modules:

* `execution/sync_state.py`
* `execution/utils/execution_health.py`

---

## **6. Dashboard Layer (Investor + Operator UI)**

_Status: present but tied to legacy telemetry — see `docs/ARCHITECTURE_CURRENT.md` §§1, 4 and `docs/infra_v6.0_repo_topology.md` §§2.1–2.2, 4._

### **6.1 Multi-Strategy Dashboard**

* Portfolio equity curve
* Per-strategy returns
* Veto streams
* Position monitor
* NAV + risk overview
* Router health chart
* ML predictions (optional)

Modules:

* `dashboard/app.py`
* `dashboard/utils.py`
* `dashboard/pages/*.py`

### **6.2 Blended Fund View**

* Aggregated NAV
* Exposure
* Drawdown
* Rolling Sharpe
* Correlation heatmap

---

## **7. Market Data + Oracles**

### **7.1 Price + Filters**

* Binance USD-M orderbook
* Price index
* Filters (LOT_SIZE, MIN_NOTIONAL)
* Spread + L2 depth

### **7.2 External Feeds**

* Coingecko USD→ZAR
* ML feature pipelines
* Optional CEX/On-chain hybrid feeds

Modules:

* `execution/data_sources/*`

---

## **8. Research Layer**

### **8.1 Backtest Engine**

* Unified vectorbt-lite backtesting
* Runbook for parameter sweeps
* Optimization pipeline with Monte Carlo

### **8.2 Research Outputs**

* Strategy reports
* Factor diagnostics
* Equity curve comparisons

### **8.3 Research Notebooks**

* Located under `/research/…`

---

## **9. DevOps + Environments**

_Status: incomplete — supervisor wrappers exist but container/CI assets are placeholders (`docs/ARCHITECTURE_CURRENT.md` §§1, 5; `docs/infra_v6.0_repo_topology.md` §§1.1, 5–7)._

### **9.1 Supervisor Services**

* hedge-executor
* hedge-dashboard
* hedge-sync

### **9.2 Runtime Controls**

* .env
* ALLOW_PROD_WRITE
* ENV=prod/testnet/dev

### **9.3 Repo Hygiene**

* Codex audits
* Schema validation
* Diff-based config checks

---

## **10. v6.0 Expansion Modules**

### **10.1 Multi-Exchange Switchboard**

* Binance
* OKX (optional)
* Deribit (optional)

### **10.2 Multi-Account Routing**

* Asset-specific accounts
* Internal fund-of-funds layout

### **10.3 RL/ML Live Features**

* Real-time predictors
* Meta-signals
* Adaptive risk scaling

### **10.4 Broker Abstraction Layer**

* Unified interface:
  `broker.send_order()` → native venue msg
* Retry policies
* Circuit-breakers
* Auth rotation
