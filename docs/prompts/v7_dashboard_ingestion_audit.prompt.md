# v7 Dashboard Ingestion Audit Prompt
# Mode: Codex IDE / CLI
# Branch: v7-risk-tuning

Goal:
Perform a full audit of the v7 Dashboard → State → Telemetry ingestion pipeline to identify:
- schema drift,
- missing v7 KPIs,
- misaligned/not-consumed state fields,
- missing formatting helpers,
- incorrect or legacy field references,
- empty/blank dashboard elements that should be populated by v7 state fields.

Do NOT focus on styling or visual design.
This is an ingestion + logic audit only.

The dashboard currently shows:
- NAV misalignment (correct source now patched but values still drifting)
- Missing AUM slices
- Missing fee/PnL ratio
- Missing drawdown %, ATR ratio
- Missing router fill/fallback KPIs
- Positions missing `notional_fmt` and `pnl_fmt`
- KPI cards blank where v7 telemetry *does* emit values

We want Codex to:
1. Audit all dashboard ingestion functions
2. Compare them to actual state files under `logs/state/`
3. Produce a patch plan to fix the ingestion layer
4. Optionally generate patches if safe to do so

---

## 1. Files to inspect (do not modify yet)

### Primary dashboard ingestion files:
- `dashboard/nav_helpers.py`
- `dashboard/live_helpers.py`
- `dashboard/router_health.py`
- `dashboard/router_policy.py`
- `dashboard/intel_panel.py`
- `dashboard/pipeline_panel.py`
- `dashboard/dashboard_utils.py`
- `dashboard/app.py`

### State + telemetry context:
- `execution/state_publish.py`
- `execution/sync_state.py`
- `execution/utils/execution_health.py`
- `execution/utils/metrics.py`
- `execution/router_metrics.py`

### v7 documentation for reference:
- `/mnt/data/v7_Telemetry.md`
- `/mnt/data/v7_Dashboard_Spec.md`

Provide explicit references to these files when identifying mismatches.

---

## 2. Audit Checklist

Codex should check each of the following:

### A. NAV / AUM ingestion
- Is the dashboard reading:
  - `logs/state/nav_state.json` for NAV? (correct)
  - `logs/state/aum_v7.json` or equivalent (if produced)?
- Are AUM slices being generated by sync_state/state_publish?
  - If yes → is dashboard reading them?
  - If no → recommend where to generate them.
- Does dashboard expect fields that are not emitted (e.g. `aum_usd`, `aum_zar`, `aum_breakdown`)?

### B. KPI ingestion (v7 KPIs)
From v7 telemetry spec:
- `atr_regime`
- `dd_state`
- `fee_pnl_ratio`
- `router_quality`
- `router_fill_ratio`
- `router_fallback_ratio`

Check that dashboard:
- reads the correct KPI file (`logs/state/kpis_v7.json`)
- extracts fields correctly
- displays values (not blank)
- handles None/NaN gracefully

### C. Router metrics
Audit:
- `dashboard/router_health.py`
- `execution/router_metrics.py`
- router metrics JSON files under state

Check:
- all router metrics fields expected by dashboard actually exist
- all router metrics emitted by execution stack are consumed by dashboard
- fallback → dashboard shows "taker" or fallback ratio if available

### D. Positions formatting
Audit `live_helpers.py`:

Check if:
- Positions include `notional_fmt`
- `pnl_fmt` is computed properly
- ATR/DD symbol-level metrics appear in positions table
- Missing or inconsistent formatting logic is causing blanks

### E. Unused / legacy ingestion code
Flag:
- any references to v6 state files (nav.json, positions_v6.json, router_state_v6.json, etc.)
- deprecated fields that no longer exist in v7 state
- any path that prefers an old file over v7 ones

### F. Missing ingestion logic
Identify missing ingestion for:
- drawdown %
- ATR ratio
- router fill/fallback fields
- fee/PnL ratio
- AUM slices
- total equity slicing (spot + futures + metals + USDC)

### G. Alignment with v7 Telemetry Contract
Cross-check:
- For every field defined in `/mnt/data/v7_Telemetry.md`, confirm dashboard ingests it
- For each missing field → list file + line number where ingestion should be added

---

## 3. Output Format

Codex must return THREE THINGS:

### (1) **Discrepancy Report**
- A bullet list of every mismatch between dashboard ingestion and v7 telemetry/state
- Include file:line annotations

### (2) **Patch Plan**
- Ordered list of concrete fixes
- For each fix:
  - exact file(s)
  - function names
  - what field(s) to add, remove, or realign
  - any required formatting helpers

### (3) **(Optional) Apply Patches**
If the remediation is small + safe, generate diffs.
If any fixes are larger or structural, generate only patch plans and wait for confirmation.

---

## Notes for Codex

- Never delete fields from state publishers unless they are provably unused AND safe.
- Prefer additive fixes.
- Fix ingestion, not runtime risk logic.
- Maintain the unlevered sizing contract.
- Keep drawdown/ATR logic read-only (already implemented in risk stack).
- Avoid circular imports between dashboard helpers.

---

## Acceptance Criteria

After implementing Codex’s recommended patches:
- Dashboard NAV matches execution NAV within < 1s delay
- AUM donut has all slices: futures + BTC + XAUT + USDC
- KPI panel shows populated:
  - ATR regime
  - Drawdown state
  - Fee/PnL
  - Router quality
- Positions table shows:
  - notional_fmt
  - pnl_fmt
  - symbol-level ATR/DD metrics
- Router panel shows:
  - maker/taker fill %
  - fallback %
  - slippage_bps
- No blank fields except where state is genuinely missing

---

# END OF PROMPT
