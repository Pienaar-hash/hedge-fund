# == v7_risk_tuning_patch.prompt == #

• - Expanded risk diagnostics to carry gate/thresholds/observations consistently across execution/
    risk_limits.py, execution/risk_engine_v6.py, and executor veto logs; nav guard and drawdown vetoes now
    emit richer detail and veto files/logs include diagnostics.
  - Added drawdown state classification and ATR regime summarization (execution/utils/execution_health.py,
    execution/risk_limits.py) so risk snapshots now expose dd_state and ATR regime context.
  - Introduced fee/PnL ratio helper (execution/utils/metrics.py) and v7 KPI publisher with aggregated
    ATR regime, drawdown state, fee/PnL ratio, and router quality; writes to logs/state/kpis_v7.json via
    execution/state_publish.py and attaches to risk snapshots in execution/executor_live.py.
  - Added tests for the new health/KPI helpers and fee/PnL ratio (tests/test_execution_health.py, tests/
    test_metrics_fee_pnl_ratio.py).

  Tests: pytest tests/test_execution_health.py tests/test_metrics_fee_pnl_ratio.py

  Next steps you may want: 1) Wire the dashboard to consume logs/state/kpis_v7.json and the new dd_state/
  ATR fields. 2) Consider surfacing per-symbol ATR/DD details in dashboards if needed.

• Added v7 KPI ingestion to the dashboard and exposed the new risk states. Key changes:

  - dashboard/live_helpers.py now loads logs/state/kpis_v7.json, enriches execution KPIs with global
    ATR regime, drawdown state, fee/PnL ratio, router quality, and per-symbol ATR/DD state via execution
    health.
  - dashboard/app.py renders a v7 KPI panel (drawdown state, ATR regime, fee/PnL ratio, router quality)
    and shows per-symbol ATR regimes when available.
  - Kept existing flows intact; code compiles.

  Next options:

  1. Surface the symbol-level dd_state_symbol/ATR fields in the UI (e.g., within position tables or symbol
     detail panels).
  2. Wire any downstream consumers to read kpis_v7.json directly if they need the same KPIs outside the
     dashboard.

• - Positions table now surfaces symbol-level risk/volatility context: dashboard/app.py enriches each row
    with dd_state, dd_today_pct, atr_regime, and atr_ratio by calling the KPI/health helpers; hook updated
    to accept preloaded v7 KPIs.
  - dashboard/live_helpers.py exposes KPI_V7_STATE_PATH, a load_kpis_v7 helper for downstream consumers,
    and allows execution_kpis to accept a preloaded KPI snapshot to avoid re-reads; execution KPIs now
    include v7 fields and per-symbol ATR/DD where available.

  You can reuse load_kpis_v7() (logs/state/kpis_v7.json) for any other consumers outside the dashboard.