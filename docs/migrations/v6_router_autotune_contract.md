# v6 Router Auto-Tune Contract

## Inputs
- Router health snapshot (`logs/state/router_health.json`) generated by `_build_router_health_snapshot()` (`execution/executor_live.py:152-193`). Each symbol entry contains maker/fallback ratios, slippage percentiles, and current policy metadata.
- Expectancy snapshot (`logs/state/expectancy_v6.json`) from `execution/intel/expectancy_v6.py:260-333`.
- Symbol scores (`logs/state/symbol_scores_v6.json`) from `execution/intel/symbol_score_v6.py:1-137`.
- Risk limits config for bounds (`config/risk_limits.json:1-74`). `execution/intel/router_autotune_v6.AutotuneBounds` clamps deltas per the `router_autotune_v6` section if present.

## Suggestion builder
- Module: `execution/intel/router_autotune_v6.py:1-200`.
- Flow: classify each symbol's router regime/quality, compute expectancy+score strength, derive maker/taker bias adjustments, and propose offset tweaks bounded by `min/max_bias` and `min/max_offset_bps`.
- Output schema (per symbol):
  ```json
  {
    "symbol": "BTCUSDT",
    "regime": "maker_strong",
    "quality": "good",
    "current_policy": {"maker_first": true, "taker_bias": 0.5, "offset_bps": 2.0},
    "proposed_policy": {"maker_first": true, "taker_bias": 0.35, "offset_bps": 2.5},
    "rationale": ["Router regime=maker_strong...", "Positive expectancy ..."],
    "lookback_days": 7.0
  }
  ```
- File: `logs/state/router_policy_suggestions_v6.json` via `write_router_policy_suggestions_state()` (`execution/state_publish.py:122-125`). The executor refreshes this at most every `ROUTER_AUTOTUNE_V6_REFRESH_INTERVAL_S` seconds.
- Tests: `tests/test_router_autotune_v6.py:1-60` ensures maker vs taker moves respect bounds and expectancy weighting.

## Application logic
- Module: `execution/intel/router_autotune_apply_v6.py:1-155`.
- Env/flag gates: `ROUTER_AUTOTUNE_V6_ENABLED` toggles suggestion generation, `ROUTER_AUTOTUNE_V6_APPLY_ENABLED` controls whether apply() can mutate live policies. Additional env knobs include `ROUTER_AUTOTUNE_V6_SYMBOL_ALLOWLIST`, `ROUTER_AUTOTUNE_V6_MAX_BIAS_DELTA`, `ROUTER_AUTOTUNE_V6_MAX_OFFSET_STEP_BPS`, `ROUTER_AUTOTUNE_V6_ALLOW_FLIP`, and `ROUTER_AUTOTUNE_V6_REQUIRE_QUALITY`.
- Risk-mode guard: `get_current_risk_mode()` reads `logs/state/risk_allocation_suggestions_v6.json`; suggestions are ignored whenever the allocator reports `risk_mode == "defensive"`. Missing or stale allocator state logs a structured warning and falls back to a cautious risk mode (not defensive) so router auto-apply does not stall while telemetry catches up; only fresh `risk_mode="defensive"` blocks changes.
- Application contract:
  - Maker/taker bias adjustments are clamped to `MAX_BIAS_DELTA` per call and never exceed `[0,1]`.
  - Offset adjustments are limited to `MAX_OFFSET_STEP_BPS` per call and `MAX_OFFSET_ABS_BPS` absolute.
  - Maker-first flips only occur if `ALLOW_MAKER_FLIP` is true **and** `risk_mode == "normal"`.
  - Symbols outside the allowlist are untouched.
- Applied policies and offsets are returned to callers (`execution/order_router.route_order()`) along with a boolean `changed` indicator so routing logs can record whether a suggestion was used.
- Tests: `tests/test_router_autotune_apply_v6.py:1-80` covers every gate (flag off, defensive risk mode, quality filter, bounded deltas).

## Observability
- `logs/state/router_policy_suggestions_v6.json` is the authoritative record of what the system wants to do.
- Router events (`logs/execution/order_metrics.jsonl`) include the policy that was actually used per attempt; comparing these to suggestions shows how many were applied.
- `execution/executor_live.py:341-390` logs `[intel]` messages when routers suggestions are written; `_maybe_emit_router_health_snapshot()` already records maker/fallback ratios so you can correlate.

The contract above is current for v6.0-rcâ€”there are no references to legacy router dashboards or v5 toggles, and every change flows through the JSON artifacts stored under `logs/state/`.
