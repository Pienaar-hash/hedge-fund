# v7.6 Developer Guide

## Entrypoints
- **Executor**: `bin/run-executor.sh` (`execution/executor_live.py`) — main loop screener → risk → router; writes canonical state.
- **Dashboard**: `bin/run-dashboard.sh` (Streamlit `dashboard/app.py`) — reads `logs/state/*` via `dashboard/state_v7.py`.
- **State mirror**: `bin/run-sync.sh` (`execution/sync_state.py`) — mirrors state for dashboard; only owns `nav_state.json`.
- **Daemons/Probes**: `scripts/strategy_probe.py`, `scripts/pipeline_shadow_heartbeat.py`, `scripts/pipeline_compare_service.py`, `scripts/run_executor_once.sh`.

## Repo Layout (active surfaces)
- `execution/`: screener (`signal_screener.py`), risk (`risk_limits.py`, `risk_engine_v6.py`), routing (`order_router.py`, `intel/*`), exits (`exit_scanner.py`, `position_ledger.py`, `position_tp_sl_registry.py`), telemetry (`state_publish.py`, `events.py`, `router_metrics.py`, `diagnostics_metrics.py`).
- `dashboard/`: Streamlit panels + loaders (`state_v7.py`, `nav_helpers.py`, `router_health.py`, `risk_panel.py`, `intel_panel.py`).
- `config/`: strategy/risk/runtime/universe/tiers/diagnostics (`strategy_config.json`, `risk_limits.json`, `runtime.yaml`, `pairs_universe.json`, `symbol_tiers.json`).
- `tests/`: `tests/unit/`, `tests/integration/` (default discovery), `tests/legacy/` (marked `legacy` + skipped).
- `logs/state/`: canonical JSON state writers (see State Contract).

## State Contract (implementation touchpoints)
- **Canonical writers** live in `executor_live.py` using helpers from `state_publish.py`; `sync_state.py` mirrors but never owns writers except `nav_state.json`.
- Single-writer rule per state file; atomic JSON writes only. Required files: `nav.json`, `nav_state.json`, `positions_state.json`, `positions_ledger.json`, `risk_snapshot.json`, `router_health.json`, `diagnostics.json`, `factor_diagnostics.json`.
- When adding fields, update both publisher and consumer (dashboard/state loaders) and extend schema smoke tests if needed.

## Diagnostics & Telemetry
- Veto metrics / exit pipeline / liveness counters live in `execution/diagnostics_metrics.py`; persisted via `write_runtime_diagnostics_state`.
- Router and order events: `logs/execution/orders_executed.jsonl`, `order_metrics.jsonl`; risk vetoes in `logs/execution/risk_vetoes.jsonl`.
- Dashboard renders veto heatmap, exit pipeline KPIs, liveness tiles from `diagnostics.json`.

## Development Guidelines
- **Risk & caps**: adjust in `risk_limits.py`/`risk_engine_v6.py`; keep caps fractional; NAV anomaly guard lives in `drawdown_tracker.compute_intraday_drawdown`.
- **Routing tweaks**: `order_router.py` + `execution/intel/*` for offsets/policies/autotune; respect post-only → taker fallback.
- **State changes**: add via `state_publish.py` helpers; ensure `sync_state.py` mirrors if dashboard needs it; keep single-writer invariant.
- **Tests**: canonical green bar `make test` or `PYTHONPATH=. pytest tests/unit tests/integration -q`; runtime schema/diagnostics covered in integration tests (`test_state_files_schema.py`, `test_state_publish_diagnostics.py`, `test_veto_metrics.py`, `test_exit_pipeline_contract.py`). Use `-m legacy` to include v5/v6 legacy lane when needed.
