# v7.6 Change Log

Developer-facing changelog organized by subsystem. Each item references the implementing patch.

---

## Runtime & Execution

### P1: Router Microstructure Intelligence
- **RouterStats accumulator** (`execution/order_router.py`): tracks per-symbol slippage, latency, TWAP usage with bounded rolling window
- **Slippage drift buckets**: GREEN/YELLOW/RED classification based on configurable thresholds
- **Latency buckets**: FAST/NORMAL/SLOW based on `latency_ms_thresholds` config
- **TWAP usage statistics**: notional-weighted TWAP ratio and child order fill metrics
- **router_health.json v2**: global + per_symbol quality scores with all microstructure stats
- **Quality score computation**: base score with router bucket, slippage, latency, and TWAP penalties

### P4: Exit Pipeline & Ledger Reconciliation
- **Position ledger authority**: `position_ledger.py` is canonical source for positions + TP/SL
- **Ledger-registry reconciliation**: `sync_ledger_with_positions()` merges exchange state with registry
- **Exit scanner ledger-first**: uses `get_ledger_entry()` with registry fallback for TP/SL lookups
- **Coverage metrics**: `tp_sl_coverage_pct`, `underwater_without_tp_sl_count` computed per loop
- **Mismatch breakdown**: counts for `missing_ledger_positions`, `ghost_ledger_entries`, `missing_tp_sl_entries`, `stale_tp_sl_entries`

### P5: NAV & Risk Snapshot Coherence
- **NAV anomaly guards**: `max_nav_jump_pct` threshold with `nav_jump` anomaly flag
- **DD state machine**: NORMAL → DRAWDOWN → RECOVERY transitions with hysteresis
- **DD flap detection**: `dd_flap` flag when state oscillates too frequently
- **VaR/CVaR computation**: rolling window calculation with configurable limits
- **Limit breach flags**: `var_limit_breach`, `cvar_limit_breach` in risk_snapshot anomalies
- **risk_snapshot.json hardening**: `risk_mode`, `dd_state`, `anomalies` block, `circuit_breaker` status

### P8: VERSION & Engine Metadata
- **VERSION file**: canonical version string (`v7.6`)
- **engine_metadata.json**: `{version, started_ts, commit_hash, config_hash}` written at executor startup
- **Dashboard version display**: system health panel shows engine version
- **Preflight scripts**: `scripts/preflight_v7_6.py`, `scripts/runtime_sanity_check_v7_6.py`
- **Make target**: `make pretag-v7.6` runs version check + test-fast + targeted integration tests

---

## Factors & Scoring

### P2: Hybrid Scoring + Vol Regime Factor
- **Vol regime factor**: LOW/NORMAL/ELEVATED/HIGH classification based on realized volatility
- **Regime-aware sizing**: tier-based `per_symbol_nav_pct` adjustments in elevated/high vol
- **Router quality factor**: hybrid score penalizes symbols with degraded router quality
- **Factor vector extension**: `vol_regime` and `router_quality` added to factor list

### P3: Factor Diagnostics (Orthogonalization, Covariance, IR Weights)
- **Raw factor extraction**: per-symbol factor vectors (trend, carry, rv_momo, router_quality, expectancy, vol_regime)
- **Factor normalization**: z-score / range-scaling with configurable `max_abs_zscore` clamp
- **Covariance computation**: cross-factor covariance matrix, correlation matrix, factor volatilities
- **Gram-Schmidt orthogonalization**: removes factor redundancy with degeneracy detection
- **IR-based auto-weighting**: factor weights based on Information Ratio with min/max bounds
- **Weight smoothing**: EMA smoothing for factor weight stability
- **PnL attribution**: factor-level PnL contribution surface with configurable lookback
- **factor_diagnostics.json**: full analytics surface (raw factors, normalized, orthogonalized, covariance, weights, attribution)

---

## State & Diagnostics

### P4: Exit Diagnostics Mismatch Breakdown
- **mismatch_breakdown** in `diagnostics.json`: quantifies ledger vs registry discrepancies
- **Missing ledger positions**: positions from exchange not in ledger
- **Ghost ledger entries**: ledger entries without matching exchange position
- **Missing TP/SL entries**: ledger positions without TP/SL registration
- **Stale TP/SL entries**: registry entries older than configurable threshold

### P5: Anomaly Flags
- **nav_jump**: NAV changed more than `max_nav_jump_pct` between updates
- **var_limit_breach**: rolling VaR exceeds configured limit
- **cvar_limit_breach**: rolling CVaR exceeds configured limit
- **dd_flap**: DD state changed more than N times in M minutes

### P7: State Contract Hardening
- **Single-writer enforcement**: executor is canonical writer for all state surfaces (except nav_state.json mirror)
- **Atomic writes**: temp file + atomic replace pattern for all state files
- **Timestamp coherence**: `updated_ts` (or `updated_at` alias) required on all surfaces
- **Schema validation**: integration tests enforce required keys per surface
- **Missing surface tolerance**: loaders emit safe defaults for missing/stale files
- **v7_manifest.json**: all state surfaces registered with path, owner, description

---

## Dashboard

### P6: Unified State Loader + Regime Badges
- **Unified state loader**: `dashboard/state_v7.py` loads all state surfaces with consistent error handling
- **Regime strip component**: horizontal badge bar showing Vol/DD/Router/Risk regimes
- **Vol regime badge**: LOW (green) / NORMAL (blue) / ELEVATED (yellow) / HIGH (red)
- **DD state badge**: NORMAL (green) / DRAWDOWN (orange) / RECOVERY (blue)
- **Router quality badge**: score display with DEGRADED/IDLE alerts
- **Risk mode badge**: current risk posture from risk_snapshot

### P8: System Health Panel + Engine Version
- **Engine version display**: shows version from engine_metadata.json
- **Surface freshness**: staleness indicators for each state file
- **Missing surface alerts**: warnings for required but missing state files
- **Preflight link**: pointer to runtime sanity check script

---

## Tooling & CI

### Preflight Scripts
- `scripts/preflight_v7_6.py`: validates VERSION, state surface schemas, v7_manifest alignment
- `scripts/runtime_sanity_check_v7_6.py`: runtime health check (NAV, DD, risk, router, exits, factors)

### Make Targets
- `make pretag-v7.6`: version check + test-fast + targeted integration tests
- `make test-fast`: quick test subset for iteration

### CI Workflow
- `.github/workflows/ci.yml`: runs preflight on PRs targeting main
- Tag protection: v7.6 tag requires passing preflight

---

## Configuration Changes

### strategy_config.json
- `router_quality.stats_window`: rolling window size for router stats
- `router_quality.slippage_drift_bps_thresholds`: GREEN/YELLOW thresholds
- `router_quality.latency_ms_thresholds`: FAST/NORMAL thresholds
- `factor_diagnostics.orthogonalization.enabled`: toggle Gram-Schmidt
- `factor_diagnostics.auto_weighting.enabled`: toggle IR-based weights
- `factor_diagnostics.auto_weighting.ir_weight_bounds`: min/max factor weights
- `factor_diagnostics.auto_weighting.smoothing_alpha`: EMA smoothing parameter

### risk_limits.json
- `max_nav_jump_pct`: threshold for NAV anomaly detection
- `var_limit_nav_pct`: VaR limit as percentage of NAV
- `cvar_limit_nav_pct`: CVaR limit as percentage of NAV
- `dd_flap_window_minutes`: window for DD flap detection
- `dd_flap_max_transitions`: max transitions before flagging

---

## Test Coverage

### New Integration Tests
- `tests/integration/test_state_positions_ledger_contract.py`
- `tests/integration/test_state_publish_factor_diagnostics.py`
- `tests/integration/test_risk_snapshot_contract.py`
- `tests/integration/test_manifest_state_contract.py`
- `tests/integration/test_state_surface_health.py`

### Extended Tests
- `tests/integration/test_state_files_schema.py`: router_health v2, factor_diagnostics schemas
- `tests/integration/test_state_publish_diagnostics.py`: mismatch_breakdown, anomaly flags
- `tests/integration/test_veto_metrics.py`: liveness semantics validation
